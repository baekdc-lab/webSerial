<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ESP32 ì„¼ì„œ ëŒ€ì‹œë³´ë“œ (No Header â€¢ Inline Summary â€¢ 4 Charts)</title>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<style>
:root{--bg:#0b1020;--card:#131a2b;--txt:#e8eefc;--mut:#9fb2d7;--line:#22314f;--btn-bg:#1b2b4a;--btn-border:#2c3e63;--tile:#0f1526;--head:#12203a;--zebra:#10192c}
:root.light{--bg:#f5f7fa;--card:#fff;--txt:#0b1020;--mut:#5a6b8a;--line:#ccd4e0;--btn-bg:#e4e8ef;--btn-border:#b0bacb;--tile:#eef1f7;--head:#d6deec;--zebra:#eef3fb}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--txt);font:16.5px/1.45 system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,sans-serif;letter-spacing:0}
.wrap{max-width:900px;margin:16px auto;padding:0 10px}
.card{background:var(--card);border-radius:16px;padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
h1{margin:0 0 6px;font-size:22px;font-weight:800;display:flex;justify-content:space-between;align-items:center;letter-spacing:0}
.mut{color:var(--mut);margin:0 0 6px}
.mut.small{font-size:13px}
hr{border:0;border-top:1px solid var(--line);margin:12px 0}
.theme-toggle{cursor:pointer;font-size:20px;user-select:none}

/* KPI */
.kpi-grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:6px;margin-top:2px}
.tile{background:var(--tile);border-radius:12px;padding:8px 6px;text-align:center;min-height:76px;display:flex;flex-direction:column;justify-content:center}
.kpi-label{font-size:14px;color:var(--mut);letter-spacing:0}
.v{font-size:24px;font-weight:900;margin-top:2px;letter-spacing:0}
.u2{font-size:14px;color:var(--mut);line-height:1.05;margin-top:0}

/* LED */
.led{display:flex;align-items:center;gap:10px;margin-top:10px;flex-wrap:wrap}
.btn{border:0;color:#fff;padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:800;min-width:92px;font-size:14px;transition:background-color .08s ease,transform .08s ease}
.btn.on{background:#2d6bff}.btn.off{background:#32405e}.btn.active{background:#00cc66}.btn.dim{background:#1b2236}
.led-status{font-size:13px;color:var(--mut);position:relative;top:2px}

/* í† ê¸€ */
.btn.toggle{background:var(--btn-bg);border:1px solid var(--btn-border);color:var(--txt);min-width:112px}
.toggle-row{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0 10px}

/* collapsible */
.collapsible{max-height:0;overflow:hidden;transition:max-height .25s ease,opacity .2s ease;opacity:0}
.collapsible.open{max-height:2000px;opacity:1}

/* í…Œì´ë¸” (í—¤ë” ìˆ¨ê¹€) */
.tablewrap{overflow:auto;background:var(--tile);border-radius:14px;padding:0;max-height:52vh;overflow-x:hidden}
table{border-collapse:collapse;width:100%;table-layout:fixed}
thead{display:none}
tbody td{
  padding:8px 4px;border-bottom:1px solid var(--line);
  text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
  font-size:14px;font-variant-numeric:tabular-nums;letter-spacing:0;
}
tbody tr:nth-child(even){background:var(--zebra)}
col.time{width:14%} col.temp{width:15%} col.hum{width:15%} col.co2{width:20%} col.solar{width:22%} col.led{width:14%}

/* bottom summary */
.bottomRow{display:flex;justify-content:space-between;align-items:center;gap:10px;color:var(--mut)}
#mini{white-space:nowrap;font-size:13.5px;margin:0}
.timeText{font-size:12px;white-space:nowrap;margin:0 2px 0 0}

/* charts layout */
.charts{margin-top:12px;display:grid;grid-template-columns:1fr;gap:10px}
.chart{background:var(--tile);border-radius:12px;padding:8px}
.chart h3{margin:0 0 6px;font-size:14px;color:var(--mut)}
.canvas-wrap{position:relative;width:100%;height:160px}
.canvas-wrap canvas{position:absolute;inset:0;width:100%;height:100%}

@media (min-width:641px){
  .canvas-wrap{height:200px}
}
</style>
</head>
<body>
<div class="wrap"><div class="card">
  <h1>ESP32 ì„¼ì„œ ëŒ€ì‹œë³´ë“œ <span class="theme-toggle" id="themeToggle">ğŸŒ™</span></h1>
  <p class="mut">ëœë¤ ì„¼ì„œ(5ì´ˆ) Â· 1ë¶„ í‰ê· (60ê°œ) Â· LED ì œì–´</p>
  <p class="mut small" id="mqttState">ë¸Œë¡œì»¤ ì—°ê²° ì¤‘â€¦</p>

  <div class="kpi-grid">
    <div class="tile"><div class="kpi-label">ì˜¨ë„</div><div class="v" id="v_temp_val">--</div><div class="u2">Â°C</div></div>
    <div class="tile"><div class="kpi-label">ìŠµë„</div><div class="v" id="v_hum_val">--</div><div class="u2">%</div></div>
    <div class="tile"><div class="kpi-label">COâ‚‚</div><div class="v" id="v_co2_val">----</div><div class="u2">ppm</div></div>
    <div class="tile"><div class="kpi-label">ì¼ì‚¬ëŸ‰</div><div class="v" id="v_solar_val">--</div><div class="u2">W/mÂ²</div></div>
  </div>

  <div class="led">
    <button id="on"  class="btn on">LED ON</button>
    <button id="off" class="btn off">LED OFF</button>
    <div id="led" class="led-status">LED: -</div>
  </div>

  <hr>
  <div class="toggle-row">
    <button class="btn toggle" id="toggleTable">ğŸ“‹ í…Œì´ë¸” ë³´ê¸°</button>
    <button class="btn toggle" id="toggleGraph">ğŸ“Š ê·¸ë˜í”„ ë³´ê¸°</button>
  </div>

  <div id="tableSection" class="collapsible open">
    <div class="tablewrap" role="table" aria-label="ì„¼ì„œ ë¡œê·¸">
      <table>
        <colgroup><col class="time"><col class="temp"><col class="hum"><col class="co2"><col class="solar"><col class="led"></colgroup>
        <thead><tr><th>ì‹œê°„</th><th>ì˜¨ë„</th><th>ìŠµë„</th><th>COâ‚‚</th><th>ì¼ì‚¬ëŸ‰</th><th>LED</th></tr></thead>
        <tbody id="logtbl"></tbody>
      </table>
    </div>
  </div>

  <div id="graphSection" class="collapsible">
    <div class="charts">
      <div class="chart">
        <h3>ì˜¨ë„(Â°C)</h3>
        <div class="canvas-wrap"><canvas id="chTemp"></canvas></div>
      </div>
      <div class="chart">
        <h3>ìŠµë„(%)</h3>
        <div class="canvas-wrap"><canvas id="chHum"></canvas></div>
      </div>
      <div class="chart">
        <h3>COâ‚‚(ppm)</h3>
        <div class="canvas-wrap"><canvas id="chCO2"></canvas></div>
      </div>
      <div class="chart">
        <h3>ì¼ì‚¬ëŸ‰(W/mÂ²)</h3>
        <div class="canvas-wrap"><canvas id="chSolar"></canvas></div>
      </div>
    </div>
  </div>

  <hr>
  <div class="bottomRow">
    <div id="mini">ì˜¨ë„:--Â°C|ìŠµë„:--%|COâ‚‚:----ppm|ì¼ì‚¬ëŸ‰:--W/mÂ²</div>
    <div id="ts" class="timeText">â€”</div>
  </div>
</div></div>

<script>
/* ===== í…Œë§ˆ ===== */
const $=s=>document.querySelector(s);
const themeToggle=$('#themeToggle');
function applyTheme(t){
  document.documentElement.classList.toggle('light',t==='light');
  themeToggle.textContent=(t==='light')?'â˜€ï¸':'ğŸŒ™';
  renderChartsAll();
}
applyTheme(localStorage.getItem('theme')||'dark');
themeToggle.onclick=()=>{ const t=document.documentElement.classList.contains('light')?'dark':'light'; applyTheme(t); localStorage.setItem('theme',t); };

/* ===== ìºì‹œ ===== */
let histBuf = JSON.parse(localStorage.getItem('histBuf')||'[]');
let lastStatus = JSON.parse(localStorage.getItem('lastStatus')||'null');

const el = {
  mqttState: $('#mqttState'),
  tempVal: $('#v_temp_val'), humVal: $('#v_hum_val'), co2Val: $('#v_co2_val'), solarVal: $('#v_solar_val'),
  ledTxt: $('#led'), mini: $('#mini'), ts: $('#ts')
};

function toBool(v){ if(typeof v==='boolean') return v; if(typeof v==='number') return v!==0;
  if(typeof v==='string'){ const t=v.trim().toLowerCase(); return t==='1'||t==='on'||t==='true'; } return !!v; }

function syncButtons(on){
  const bon=$('#on'), boff=$('#off');
  bon.classList.remove('active','dim'); boff.classList.remove('active','dim');
  if(on){ bon.classList.add('active'); boff.classList.add('dim'); }
  else  { boff.classList.add('active'); bon.classList.add('dim'); }
}

function fmtNow(){ const d=new Date(),p=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())}`; }

function renderMiniLine(t,h,c,so){
  const tv = Number.isFinite(t)?Math.round(t):'--';
  const hv = Number.isFinite(h)?Math.round(h):'--';
  const cv = Number.isFinite(c)?Math.round(c):'----';
  const sv = Number.isFinite(so)?Math.round(so):'--';
  el.mini.textContent = `ì˜¨ë„:${tv}Â°C|ìŠµë„:${hv}%|COâ‚‚:${cv}ppm|ì¼ì‚¬ëŸ‰:${sv}W/mÂ²`;
}

function renderStatus(s){
  const t=Number(s.temp), h=Number(s.hum), c=Number(s.co2), so=Number(s.solar), led=toBool(s.led);
  if(Number.isFinite(t)) el.tempVal.textContent=String(Math.round(t*10)/10);
  if(Number.isFinite(h)) el.humVal.textContent=String(Math.round(h));
  if(Number.isFinite(c)) el.co2Val.textContent=String(Math.round(c));
  if(Number.isFinite(so)) el.solarVal.textContent=String(Math.round(so));
  el.ledTxt.textContent='LED: '+(led?'ON':'OFF'); syncButtons(led);
  renderMiniLine(t,h,c,so);
  el.ts.textContent = fmtNow();
}

function addRowTop(o,ts){
  const tb=$('#logtbl');
  const d=ts?new Date(ts):new Date();
  const hh=String(d.getHours()).padStart(2,'0'); const mm=String(d.getMinutes()).padStart(2,'0');
  const tr=document.createElement('tr');
  tr.innerHTML=`<td>${hh}:${mm}</td>
    <td>${Math.round(Number(o.temp)*10)/10}</td>
    <td>${Math.round(Number(o.hum))}</td>
    <td>${Math.round(Number(o.co2))}</td>
    <td>${Math.round(Number(o.solar))}</td>
    <td>${toBool(o.led)?'ON':'OFF'}</td>`;
  if(tb.firstChild) tb.insertBefore(tr,tb.firstChild); else tb.appendChild(tr);
  while(tb.rows.length>60) tb.deleteRow(tb.rows.length-1);
}

/* ===== 4 ê°œë³„ ì°¨íŠ¸ ===== */
const dpr = ()=> window.devicePixelRatio||1;
function prepCanvas(c){ const r=c.getBoundingClientRect(); const w=Math.max(1,r.width),h=Math.max(1,r.height);
  c.width=Math.floor(w*dpr()); c.height=Math.floor(h*dpr()); const ctx=c.getContext('2d'); ctx.setTransform(dpr(),0,0,dpr(),0,0); return ctx; }
function drawSingleSeries(c, arr, color){
  const ctx=prepCanvas(c); const W=c.clientWidth,H=c.clientHeight;
  const padL=42,padR=10,padT=10,padB=22,plotW=W-padL-padR,plotH=H-padT-padB;
  const light=document.documentElement.classList.contains('light');
  ctx.clearRect(0,0,W,H);
  ctx.fillStyle=light?'#eef1f7':'#0f1526'; ctx.fillRect(0,0,W,H);
  // axis grid
  ctx.strokeStyle=light?'#ccd4e0':'#22314f';
  ctx.beginPath();
  for(let g=0;g<=4;g++){const y=padT+plotH*g/4;ctx.moveTo(padL,y);ctx.lineTo(padL+plotW,y);}
  for(let m=0;m<=60;m+=10){const x=padL+plotW*(m/60);ctx.moveTo(x,padT);ctx.lineTo(x,padT+plotH);}
  ctx.stroke();
  // x labels
  ctx.fillStyle=light?'#5a6b8a':'#9fb2d7';
  ctx.font='12px system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,sans-serif';
  ctx.textAlign='center'; ctx.textBaseline='top';
  for(let m=0;m<=60;m+=10){const x=padL+plotW*(m/60);ctx.fillText((60-m)==0?'ì§€ê¸ˆ':`-${60-m}m`,x,padT+plotH+4);}
  // y range
  const vals=arr.filter(v=>Number.isFinite(v));
  let vmin=Math.min(...(vals.length?vals:[0])), vmax=Math.max(...(vals.length?vals:[1]));
  if(vmax===vmin){vmax=vmin+1;}
  const pad=(vmax-vmin)*0.1; vmin-=pad; vmax+=pad;
  ctx.textAlign='right'; ctx.textBaseline='middle';
  for(let g=0;g<=4;g++){const y=padT+plotH*g/4, val=vmax-(vmax-vmin)*g/4; ctx.fillText(val.toFixed((vmax-vmin)<10?1:0),padL-6,y); }
  // series
  const xAt=i=>padL+plotW*(i/59), yAt=v=>padT+((vmax-v)/(vmax-vmin))*plotH;
  ctx.beginPath(); ctx.lineWidth=2; ctx.strokeStyle=color;
  let moved=false; const N=arr.length;
  for(let i=0;i<60;i++){
    const j=i-(60-N); const v=(j>=0&&j<N)?arr[j]:NaN; const x=xAt(i);
    if(Number.isFinite(v)){const y=yAt(v); if(!moved){ctx.moveTo(x,y); moved=true;} else ctx.lineTo(x,y);} else moved=false;
  }
  ctx.stroke();
}
function renderChartsAll(){
  if(!document.getElementById('graphSection').classList.contains('open')) return;
  const tempArr = histBuf.map(r=>r.temp??NaN);
  const humArr  = histBuf.map(r=>r.hum??NaN);
  const co2Arr  = histBuf.map(r=>r.co2??NaN);
  const solArr  = histBuf.map(r=>r.solar??NaN);
  drawSingleSeries(document.getElementById('chTemp'),  tempArr, '#7aa0ff');
  drawSingleSeries(document.getElementById('chHum'),   humArr,  '#ff9a7a');
  drawSingleSeries(document.getElementById('chCO2'),   co2Arr,  '#9ad67b');
  drawSingleSeries(document.getElementById('chSolar'), solArr,  '#d0a2ff');
}

/* ===== ìºì‹œ ì¦‰ì‹œ ë°˜ì˜ ===== */
if (lastStatus) { 
  renderMiniLine(Number(lastStatus.temp), Number(lastStatus.hum), Number(lastStatus.co2), Number(lastStatus.solar));
  renderStatus(lastStatus); 
}

/* ===== MQTT ì—°ê²° ===== */
const brokerUrl = "wss://6c56aefe0ddb4d57977c735f5070abe8.s1.eu.hivemq.cloud:8884/mqtt";
const mqttOpt = { username:"mqtt_ESP32", password:"gomqtt_ESP32", clientId:"web-"+Math.random().toString(16).slice(2), clean:true, reconnectPeriod:2000 };
const client = mqtt.connect(brokerUrl, mqttOpt);
client.on('connect', ()=>{ $('#mqttState').textContent='MQTT ì—°ê²° OK'; client.subscribe('esp32/status'); });
client.on('reconnect', ()=> $('#mqttState').textContent='ë¸Œë¡œì»¤ ì¬ì—°ê²° ì¤‘â€¦');
client.on('offline',  ()=> $('#mqttState').textContent='ë¸Œë¡œì»¤ ì˜¤í”„ë¼ì¸');
client.on('error',    e => $('#mqttState').textContent='ì—ëŸ¬: '+e.message);
client.on('message', (topic,payload)=>{
  if(topic!=='esp32/status') return;
  const s = JSON.parse(new TextDecoder().decode(payload));
  renderStatus(s);
  localStorage.setItem('lastStatus', JSON.stringify(s));
  pushMinuteSample(s, new Date());
});

/* ===== LED ì œì–´ ===== */
$('#on').onclick  = ()=>{ syncButtons(true);  client.publish('esp32/led','on');  };
$('#off').onclick = ()=>{ syncButtons(false); client.publish('esp32/led','off'); };

/* ===== ì„¹ì…˜ í† ê¸€ ===== */
const secTable=$('#tableSection'), secGraph=$('#graphSection');
$('#toggleTable').onclick=()=>{ const o=secTable.classList.toggle('open'); $('#toggleTable').textContent=o?'ğŸ“‹ í…Œì´ë¸” ìˆ¨ê¸°ê¸°':'ğŸ“‹ í…Œì´ë¸” ë³´ê¸°';
  if(o && histBuf.length){
    $('#logtbl').innerHTML='';
    for(let i=0;i<histBuf.length;i++){
      const r = histBuf[i];
      const ts=new Date(); ts.setMinutes(ts.getMinutes()-(histBuf.length-1-i));
      addRowTop({...r,led:false},ts);
    }
  }
};
$('#toggleGraph').onclick=()=>{ const o=secGraph.classList.toggle('open'); $('#toggleGraph').textContent=o?'ğŸ“Š ê·¸ë˜í”„ ìˆ¨ê¸°ê¸°':'ğŸ“Š ê·¸ë˜í”„ ë³´ê¸°'; if(o) renderChartsAll(); };

/* ===== 1ë¶„ í‰ê·  ë²„í¼(ìµœëŒ€ 60ê°œ) ===== */
let minuteKey=null, minuteSamples=[];
function pushMinuteSample(s, now){
  const key=now.getHours()*60+now.getMinutes();
  if(minuteKey!==null && key!==minuteKey && minuteSamples.length){
    const avg=k=>{ const v=minuteSamples.map(x=>+x[k]).filter(Number.isFinite); return v.length?v.reduce((a,b,)=>a+b,0)/v.length:NaN; };
    const row={ temp:avg('temp'), hum:avg('hum'), co2:avg('co2'), solar:avg('solar'), led:minuteSamples.at(-1).led };
    addRowTop(row, new Date(now.getFullYear(),now.getMonth(),now.getDate(),Math.floor(minuteKey/60),minuteKey%60,0,0));
    histBuf.push({temp:row.temp, hum:row.hum, co2:row.co2, solar:row.solar});
    if(histBuf.length>60) histBuf.shift();
    localStorage.setItem('histBuf', JSON.stringify(histBuf));
    renderChartsAll();
  }
  minuteKey=key;
  minuteSamples.push({ temp:+s.temp, hum:+s.hum, co2:+s.co2, solar:+s.solar, led:toBool(s.led) });
}

/* ===== ì‹œê° ===== */
setInterval(()=>{ $('#ts').textContent=(new Date()).toLocaleString('sv-SE').replace('T',' '); },1000);
</script>
</body>
</html>
