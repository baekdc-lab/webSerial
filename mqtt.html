<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ESP32+MQTT ÏÑºÏÑú/Ï†úÏñ¥ Î≥¥Îìú</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    :root {
      --bg: #f5f5f5;
      --fg: #111827;
      --subtle: #6b7280;
      --muted: #9ca3af;
      --card-bg: #ffffff;
      --metric-bg: #fafafa;
      --shadow: 0 2px 6px rgba(0,0,0,0.08);
      --log-bg: #111827;
      --log-fg: #e5e7eb;
      --border-soft: rgba(0,0,0,0.06);
    }

    body[data-theme="dark"] {
      --bg: #020617;
      --fg: #e5e7eb;
      --subtle: #9ca3af;
      --muted: #6b7280;
      --card-bg: #020617;
      --metric-bg: #020617;
      --shadow: 0 2px 10px rgba(0,0,0,0.55);
      --log-bg: #020617;
      --log-fg: #e5e7eb;
      --border-soft: rgba(148,163,184,0.4);
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--fg);
      margin: 0;
      padding: 16px;
      transition: background 0.25s ease, color 0.25s ease;
    }

    h1 { margin-top: 0; font-size: 1.5rem; }

    .page-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 12px;
    }

    .card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 16px;
      box-shadow: var(--shadow);
      margin-bottom: 16px;
      border: 1px solid var(--border-soft);
      transition: background 0.25s ease, box-shadow 0.25s ease, border-color 0.25s ease;
    }

    .status-dot {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 6px;
      background: #9ca3af;
    }
    .status-ok { background: #22c55e; }
    .status-bad { background: #ef4444; }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 12px;
    }

    .metric {
      background: var(--metric-bg);
      border-radius: 10px;
      padding: 10px;
      text-align: center;
      border: 1px solid var(--border-soft);
      transition: background 0.25s ease, border-color 0.25s ease;
    }
    .metric-label { font-size: 0.8rem; color: var(--subtle); }
    .metric-value { font-size: 1.3rem; font-weight: 600; margin-top: 4px; }

    button {
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 0.9rem;
      cursor: pointer;
      margin-right: 8px;
      margin-top: 8px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: transform 0.08s ease, box-shadow 0.12s ease, background 0.2s ease, color 0.2s ease;
    }
    button:active {
      transform: translateY(1px);
      box-shadow: none;
    }

    #btnOn { background: #22c55e; color: #fff; box-shadow: 0 2px 6px rgba(34,197,94,0.4); }
    #btnOff { background: #ef4444; color: #fff; box-shadow: 0 2px 6px rgba(239,68,68,0.4); }

    .theme-toggle {
      background: transparent;
      color: var(--subtle);
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      padding: 6px 10px;
      font-size: 0.8rem;
      line-height: 1;
      margin: 0;
      box-shadow: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .theme-toggle-icon {
      font-size: 1.1rem;
    }

    #log {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.8rem;
      max-height: 200px;
      overflow-y: auto;
      background: var(--log-bg);
      color: var(--log-fg);
      padding: 8px;
      border-radius: 8px;
      white-space: pre-wrap;
      border: 1px solid var(--border-soft);
      transition: background 0.25s ease, color 0.25s ease, border-color 0.25s ease;
    }

    code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.8rem;
      padding: 2px 4px;
      border-radius: 4px;
      background: rgba(148,163,184,0.15);
    }

    .hint {
      font-size: 0.8rem;
      color: var(--muted);
    }
  </style>
</head>
<body data-theme="light">
  <header class="page-header">
    <h1>>ESP32+MQTT ÏÑºÏÑú/Ï†úÏñ¥ Î≥¥Îìú</h1>
    <!-- ÎùºÏù¥Ìä∏/Îã§ÌÅ¨ Î™®Îìú ÌÜ†Í∏Ä Î≤ÑÌäº (ÏïÑÏù¥ÏΩòÎßå) -->
    <button id="themeToggle" class="theme-toggle" type="button" aria-label="ÌÖåÎßà Ï†ÑÌôò">
      <span class="theme-toggle-icon">üåû</span>
    </button>
  </header>

  <!-- Î∏åÎ°úÏª§/Ïû•ÎπÑ ÏÉÅÌÉú -->
  <div class="card">
    <div>
      <span id="mqttDot" class="status-dot"></span>
      <strong id="mqttState">MQTT Ïó∞Í≤∞ ÎåÄÍ∏∞ Ï§ë...</strong>
    </div>
    <div style="margin-top:4px;font-size:0.85rem;color:var(--subtle);">
      Î∏åÎ°úÏª§: <code>broker.hivemq.com</code> (ESP32=MQTT 1883)
    </div>
    <div style="margin-top:4px;font-size:0.8rem;color:var(--muted);">
      Ïû•ÎπÑ ÏÉÅÌÉú: <span id="deviceState">Ïïå Ïàò ÏóÜÏùå</span>
    </div>
    <div style="margin-top:4px;font-size:0.8rem;color:var(--muted);">
      ÎßàÏßÄÎßâ ÏàòÏã† ÏãúÍ∞Å: <span id="lastUpdate">-</span>
    </div>
  </div>

  <!-- ÏÑºÏÑúÍ∞í/ÏÉÅÌÉú -->
  <div class="card">
    <h2 style="font-size:1.1rem;margin-top:0;">ÏÑºÏÑú ÏÉÅÌÉú (ESP32C3/STATUS)</h2>
    <div class="grid">
      <div class="metric">
        <div class="metric-label">Ïò®ÎèÑ</div>
        <div class="metric-value"><span id="valTemp">--</span> ¬∞C</div>
      </div>
      <div class="metric">
        <div class="metric-label">ÏäµÎèÑ</div>
        <div class="metric-value"><span id="valHum">--</span> %</div>
      </div>
      <div class="metric">
        <div class="metric-label">CO‚ÇÇ</div>
        <div class="metric-value"><span id="valCo2">--</span> ppm</div>
      </div>
      <div class="metric">
        <div class="metric-label">ÏùºÏÇ¨Îüâ</div>
        <div class="metric-value"><span id="valSolar">--</span> W/m¬≤</div>
      </div>
      <div class="metric">
        <div class="metric-label">LED ÏÉÅÌÉú</div>
        <div class="metric-value"><span id="valLed">--</span></div>
      </div>
      <div class="metric">
        <div class="metric-label">WiFi RSSI</div>
        <div class="metric-value"><span id="valRssi">--</span> dBm</div>
      </div>
    </div>
  </div>

  <!-- LED Ï†úÏñ¥ -->
  <div class="card">
    <h2 style="font-size:1.1rem;margin-top:0;">LED Ï†úÏñ¥ (ESP32C3/LED)</h2>
    <button id="btnOn" type="button">LED ON</button>
    <button id="btnOff" type="button">LED OFF</button>
    <div id="cmdResult" style="margin-top:8px;font-size:0.8rem;color:var(--subtle);">-</div>
  </div>

  <!-- Î°úÍ∑∏ -->
  <div class="card">
    <h2 style="font-size:1.1rem;margin-top:0;">Î°úÍ∑∏</h2>
    <div id="log"></div>
  </div>

  <script>
    const $ = (sel) => document.querySelector(sel);

    const mqttStateEl   = $("#mqttState");
    const mqttDotEl     = $("#mqttDot");
    const deviceStateEl = $("#deviceState");
    const lastUpdateEl  = $("#lastUpdate");
    const logEl         = $("#log");
    const cmdResultEl   = $("#cmdResult");

    const valTemp  = $("#valTemp");
    const valHum   = $("#valHum");
    const valCo2   = $("#valCo2");
    const valSolar = $("#valSolar");
    const valLed   = $("#valLed");
    const valRssi  = $("#valRssi");

    const btnOn   = $("#btnOn");
    const btnOff  = $("#btnOff");
    const themeToggleBtn  = $("#themeToggle");
    const themeToggleIcon = themeToggleBtn.querySelector(".theme-toggle-icon");

    // ‚îÄ‚îÄ ÌÖåÎßà Ï†ÅÏö© Í¥ÄÎ†® ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function applyTheme(theme) {
      const isDark = theme === "dark";
      document.body.setAttribute("data-theme", theme);

      if (isDark) {
        themeToggleIcon.textContent = "üåô";
      } else {
        themeToggleIcon.textContent = "üåû";
      }
    }

    (function initTheme() {
      const saved = localStorage.getItem("tswell-mqtt-theme");
      let theme = "light";

      if (saved === "light" || saved === "dark") {
        theme = saved;
      } else if (window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches) {
        theme = "dark";
      }
      applyTheme(theme);
    })();

    themeToggleBtn.addEventListener("click", () => {
      const current = document.body.getAttribute("data-theme") || "light";
      const next = current === "dark" ? "light" : "dark";
      localStorage.setItem("tswell-mqtt-theme", next);
      applyTheme(next);
    });

    // ‚îÄ‚îÄ Î°úÍ∑∏ Ï∂úÎ†• ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function log(msg) {
      const time = new Date().toLocaleTimeString();
      logEl.textContent += `[${time}] ${msg}\n`;
      logEl.scrollTop = logEl.scrollHeight;
    }

    function setMqttStatus(ok, text) {
      mqttDotEl.classList.remove("status-ok", "status-bad");
      if (ok) mqttDotEl.classList.add("status-ok");
      else    mqttDotEl.classList.add("status-bad");
      mqttStateEl.textContent = text;
    }

    function setDeviceState(alive) {
      if (alive) {
        deviceStateEl.textContent = "Ïò®ÎùºÏù∏";
        deviceStateEl.style.color = "#16a34a";
      } else {
        deviceStateEl.textContent = "Ïò§ÌîÑÎùºÏù∏";
        deviceStateEl.style.color = "#dc2626";
      }
    }

    // ‚îÄ‚îÄ MQTT Ïó∞Í≤∞ ÏÑ§Ï†ï ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const brokerUrl = "wss://broker.hivemq.com:8884/mqtt";

    const options = {
      clean: true,
      connectTimeout: 4000,
      reconnectPeriod: 5000,
    };

    const client = mqtt.connect(brokerUrl, options);
    let lastDeviceMsgAt = null;

    client.on("connect", () => {
      setMqttStatus(true, "MQTT Ïó∞Í≤∞ OK");
      log("MQTT Ïó∞Í≤∞ ÏÑ±Í≥µ");

      const topicStatus = "esp32c3/status";
      client.subscribe(topicStatus, (err) => {
        if (err) log("Íµ¨ÎèÖ Ïã§Ìå®: " + err.message);
        else     log("Íµ¨ÎèÖ ÏÑ±Í≥µ: " + topicStatus);
      });
    });

    client.on("reconnect", () => {
      setMqttStatus(false, "MQTT Ïû¨Ïó∞Í≤∞ ÏãúÎèÑ Ï§ë...");
      log("Ïû¨Ïó∞Í≤∞ ÏãúÎèÑ...");
    });

    client.on("error", (err) => {
      setMqttStatus(false, "MQTT ÏóêÎü¨");
      log("ÏóêÎü¨: " + err.message);
    });

    client.on("close", () => {
      setMqttStatus(false, "MQTT Ïó∞Í≤∞ ÎÅäÍπÄ");
      log("MQTT Ïó∞Í≤∞ ÎÅäÍπÄ");
    });

    client.on("message", (topic, payload) => {
      const text = new TextDecoder().decode(payload);
      log(`ÏàòÏã† (${topic}): ${text}`);

      const trimmed = text.trim();
      if (!trimmed.startsWith("{")) {
        // online / offline / Aktif Í∞ôÏùÄ Î¨∏ÏûêÏó¥ÏùÄ Ï°∞Ïö©Ìûà Î¨¥Ïãú
        return;
      }

      let data;
      try {
        data = JSON.parse(trimmed);
      } catch (e) {
        log("JSON ÌååÏã± Ïã§Ìå®");
        return;
      }

      lastDeviceMsgAt = Date.now();
      if ("alive" in data) {
        setDeviceState(!!data.alive);
      } else {
        // alive ÌïÑÎìú ÏóÜÏúºÎ©¥ ÏùºÎã® Ïò®ÎùºÏù∏ÏúºÎ°ú Ï∑®Í∏â
        setDeviceState(true);
      }

      if ("temp"  in data) valTemp.textContent  = Number(data.temp).toFixed(1);
      if ("hum"   in data) valHum.textContent   = Number(data.hum).toFixed(1);
      if ("co2"   in data) valCo2.textContent   = Number(data.co2).toFixed(0);
      if ("solar" in data) valSolar.textContent = Number(data.solar).toFixed(0);
      if ("led"   in data) valLed.textContent   = data.led ? "ON" : "OFF";
      if ("rssi"  in data) valRssi.textContent  = Number(data.rssi).toFixed(0);

      lastUpdateEl.textContent = new Date().toLocaleString();
    });

    // heartbeat ÌÉÄÏûÑÏïÑÏõÉ ‚Äì 10Ï¥à Ïù¥ÏÉÅ Î©îÏãúÏßÄ ÏóÜÏúºÎ©¥ Ïò§ÌîÑÎùºÏù∏ÏúºÎ°ú ÌëúÏãú
    setInterval(() => {
      if (!lastDeviceMsgAt) return;
      const diff = Date.now() - lastDeviceMsgAt;
      if (diff > 10000) { // 10Ï¥à
        setDeviceState(false);
      }
    }, 2000);

    // ‚îÄ‚îÄ LED Ï†úÏñ¥ Publish ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function publishLed(cmd) {
      if (!client.connected) {
        cmdResultEl.textContent = "MQTTÍ∞Ä Ïó∞Í≤∞ÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.";
        return;
      }
      const topic = "esp32c3/led";
      client.publish(topic, cmd, { qos: 0, retain: false }, (err) => {
        if (err) {
          cmdResultEl.textContent = "Ï†ÑÏÜ° Ïã§Ìå®: " + err.message;
          log("LED publish Ïã§Ìå®: " + err.message);
        } else {
          cmdResultEl.textContent = `Ï†ÑÏÜ° ÏôÑÎ£å: ${cmd}`;
          log(`LED Î™ÖÎ†π Ï†ÑÏÜ° (${topic}): ${cmd}`);
        }
      });
    }

    btnOn.addEventListener("click", () => publishLed("LED_ON"));
    btnOff.addEventListener("click", () => publishLed("LED_OFF"));
  </script>
</body>
</html>



