<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ESP32-C3 + HiveMQ 데모 보드</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 16px;
    }
    h1 { margin-top: 0; font-size: 1.5rem; }
    .card {
      background: #fff;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      margin-bottom: 16px;
    }
    .status-dot {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 6px;
      background: #ccc;
    }
    .status-ok { background: #2ecc71; }
    .status-bad { background: #e74c3c; }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 12px;
    }
    .metric {
      background: #fafafa;
      border-radius: 10px;
      padding: 10px;
      text-align: center;
    }
    .metric-label { font-size: 0.8rem; color: #666; }
    .metric-value { font-size: 1.3rem; font-weight: 600; margin-top: 4px; }
    button {
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 0.9rem;
      cursor: pointer;
      margin-right: 8px;
      margin-top: 8px;
    }
    #btnOn { background: #2ecc71; color: #fff; }
    #btnOff { background: #e74c3c; color: #fff; }
    #log {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.8rem;
      max-height: 200px;
      overflow-y: auto;
      background: #111;
      color: #ddd;
      padding: 8px;
      border-radius: 8px;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <h1>ESP32-C3 + HiveMQ 데모 대시보드</h1>

  <!-- 브로커/장비 상태 -->
  <div class="card">
    <div>
      <span id="mqttDot" class="status-dot"></span>
      <strong id="mqttState">MQTT 연결 대기 중...</strong>
    </div>
    <div style="margin-top:4px;font-size:0.85rem;color:#555;">
      브로커: <code>broker.hivemq.com</code> (ESP32=MQTT 1883)
    </div>
    <div style="margin-top:4px;font-size:0.8rem;color:#777;">
      장비 상태: <span id="deviceState">알 수 없음</span>
    </div>
    <div style="margin-top:4px;font-size:0.8rem;color:#777;">
      마지막 수신 시각: <span id="lastUpdate">-</span>
    </div>
  </div>

  <!-- 센서값/상태 -->
  <div class="card">
    <h2 style="font-size:1.1rem;margin-top:0;">센서 상태 (ESP32C3/STATUS)</h2>
    <div class="grid">
      <div class="metric">
        <div class="metric-label">온도</div>
        <div class="metric-value"><span id="valTemp">--</span> °C</div>
      </div>
      <div class="metric">
        <div class="metric-label">습도</div>
        <div class="metric-value"><span id="valHum">--</span> %</div>
      </div>
      <div class="metric">
        <div class="metric-label">CO₂</div>
        <div class="metric-value"><span id="valCo2">--</span> ppm</div>
      </div>
      <div class="metric">
        <div class="metric-label">일사량</div>
        <div class="metric-value"><span id="valSolar">--</span> W/m²</div>
      </div>
      <div class="metric">
        <div class="metric-label">LED 상태</div>
        <div class="metric-value"><span id="valLed">--</span></div>
      </div>
      <div class="metric">
        <div class="metric-label">WiFi RSSI</div>
        <div class="metric-value"><span id="valRssi">--</span> dBm</div>
      </div>
    </div>
  </div>

  <!-- LED 제어 -->
  <div class="card">
    <h2 style="font-size:1.1rem;margin-top:0;">LED 제어 (ESP32C3/LED)</h2>
    <button id="btnOn">LED ON</button>
    <button id="btnOff">LED OFF</button>
    <div id="cmdResult" style="margin-top:8px;font-size:0.8rem;color:#555;">-</div>
  </div>

  <!-- 로그 -->
  <div class="card">
    <h2 style="font-size:1.1rem;margin-top:0;">로그</h2>
    <div id="log"></div>
  </div>

  <script>
    const $ = (sel) => document.querySelector(sel);

    const mqttStateEl  = $("#mqttState");
    const mqttDotEl    = $("#mqttDot");
    const deviceStateEl= $("#deviceState");
    const lastUpdateEl = $("#lastUpdate");
    const logEl        = $("#log");
    const cmdResultEl  = $("#cmdResult");

    const valTemp  = $("#valTemp");
    const valHum   = $("#valHum");
    const valCo2   = $("#valCo2");
    const valSolar = $("#valSolar");
    const valLed   = $("#valLed");
    const valRssi  = $("#valRssi");

    const btnOn  = $("#btnOn");
    const btnOff = $("#btnOff");

    function log(msg) {
      const time = new Date().toLocaleTimeString();
      logEl.textContent += `[${time}] ${msg}\n`;
      logEl.scrollTop = logEl.scrollHeight;
    }

    function setMqttStatus(ok, text) {
      mqttDotEl.classList.remove("status-ok", "status-bad");
      if (ok) mqttDotEl.classList.add("status-ok");
      else    mqttDotEl.classList.add("status-bad");
      mqttStateEl.textContent = text;
    }

    function setDeviceState(alive) {
      if (alive) {
        deviceStateEl.textContent = "온라인";
        deviceStateEl.style.color = "#16a34a";
      } else {
        deviceStateEl.textContent = "오프라인";
        deviceStateEl.style.color = "#dc2626";
      }
    }

    const brokerUrl = "wss://broker.hivemq.com:8884/mqtt";

    const options = {
      clean: true,
      connectTimeout: 4000,
      reconnectPeriod: 5000,
    };

    const client = mqtt.connect(brokerUrl, options);

    let lastDeviceMsgAt = null;

    client.on("connect", () => {
      setMqttStatus(true, "MQTT 연결 OK");
      log("MQTT 연결 성공");

      const topicStatus = "esp32c3/status";
      client.subscribe(topicStatus, (err) => {
        if (err) log("구독 실패: " + err.message);
        else     log("구독 성공: " + topicStatus);
      });
    });

    client.on("reconnect", () => {
      setMqttStatus(false, "MQTT 재연결 시도 중...");
      log("재연결 시도...");
    });

    client.on("error", (err) => {
      setMqttStatus(false, "MQTT 에러");
      log("에러: " + err.message);
    });

    client.on("close", () => {
      setMqttStatus(false, "MQTT 연결 끊김");
      log("MQTT 연결 끊김");
    });

    client.on("message", (topic, payload) => {
      const text = new TextDecoder().decode(payload);
      log(`수신 (${topic}): ${text}`);

      const trimmed = text.trim();
      if (!trimmed.startsWith("{")) {
        // online / offline / Aktif 같은 문자열은 조용히 무시
        return;
      }

      let data;
      try {
        data = JSON.parse(trimmed);
      } catch (e) {
        log("JSON 파싱 실패");
        return;
      }

      lastDeviceMsgAt = Date.now();
      if ("alive" in data) {
        setDeviceState(!!data.alive);
      } else {
        // alive 필드 없으면 일단 온라인으로 취급
        setDeviceState(true);
      }

      if ("temp"  in data) valTemp.textContent  = Number(data.temp).toFixed(1);
      if ("hum"   in data) valHum.textContent   = Number(data.hum).toFixed(1);
      if ("co2"   in data) valCo2.textContent   = Number(data.co2).toFixed(0);
      if ("solar" in data) valSolar.textContent = Number(data.solar).toFixed(0);
      if ("led"   in data) valLed.textContent   = data.led ? "ON" : "OFF";
      if ("rssi"  in data) valRssi.textContent  = Number(data.rssi).toFixed(0);

      lastUpdateEl.textContent = new Date().toLocaleString();
    });

    // heartbeat 타임아웃(백업용) – 10초 이상 메시지 없으면 오프라인으로 표시
    setInterval(() => {
      if (!lastDeviceMsgAt) return;
      const diff = Date.now() - lastDeviceMsgAt;
      if (diff > 10000) { // 10초
        setDeviceState(false);
      }
    }, 2000);

    function publishLed(cmd) {
      if (!client.connected) {
        cmdResultEl.textContent = "MQTT가 연결되지 않았습니다.";
        return;
      }
      const topic = "esp32c3/led";
      client.publish(topic, cmd, { qos: 0, retain: false }, (err) => {
        if (err) {
          cmdResultEl.textContent = "전송 실패: " + err.message;
          log("LED publish 실패: " + err.message);
        } else {
          cmdResultEl.textContent = `전송 완료: ${cmd}`;
          log(`LED 명령 전송 (${topic}): ${cmd}`);
        }
      });
    }

    btnOn.addEventListener("click", () => publishLed("LED_ON"));
    btnOff.addEventListener("click", () => publishLed("LED_OFF"));
  </script>
</body>
</html>

