<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ESP32 ì„¼ì„œ ëŒ€ì‹œë³´ë“œ</title>
<style>
:root{
  --bg:#0b1020;--card:#131a2b;--txt:#e8eefc;--mut:#9fb2d7;--line:#22314f;
  --btn-bg:#1b2b4a;--btn-border:#2c3e63;
  --ok:#28d07f;--bad:#ff6b6b;
}
:root.light{
  --bg:#f5f7fa;--card:#ffffff;--txt:#0b1020;--mut:#5a6b8a;--line:#ccd4e0;
  --btn-bg:#e4e8ef;--btn-border:#b0bacb;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--txt);font:16px/1.5 system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,sans-serif;transition:background .3s,color .3s}
.wrap{max-width:900px;margin:20px auto;padding:0 12px}
.card{background:var(--card);border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25);transition:background .3s}
h1{margin:0 0 8px;font-size:26px;font-weight:800;display:flex;justify-content:space-between;align-items:center}
.mut{color:var(--mut);margin:0 0 12px}
.status{margin-top:8px;color:var(--mut);font-size:14px;white-space:pre-line}
hr{border:0;border-top:1px solid var(--line);margin:14px 0;transition:border-color .3s}

/* Theme toggle */
.theme-toggle{cursor:pointer;font-size:22px;user-select:none;transition:transform .2s}
.theme-toggle:hover{transform:scale(1.15)}

/* KPI Tiles */
.grid{display:grid;grid-template-columns:repeat(5,minmax(0,1fr));gap:12px;margin-top:6px}
.tile{background:#0f1526;border-radius:12px;padding:12px;text-align:center;min-height:76px;transition:background .3s}
:root.light .tile{background:#eef1f7}
.v{font-size:22px;font-weight:800;margin-top:4px}

/* LED ë²„íŠ¼ */
.led{display:flex;align-items:center;gap:12px;margin-top:12px;flex-wrap:wrap}
.btn{border:0;color:#fff;padding:12px 14px;border-radius:12px;cursor:pointer;font-weight:800;min-width:98px;font-size:15px;transition:all .2s}
.btn.on{background:#2d6bff;} .btn.off{background:#32405e;} .btn.active{background:#00cc66;} .btn.dim{background:#1b2236;}
.btn.toggle{background:var(--btn-bg);border:1px solid var(--btn-border);color:var(--txt);min-width:120px}

/* ìˆ¨ê¹€/í¼ì¹¨ ì• ë‹ˆë©”ì´ì…˜ */
.collapsible{max-height:0;overflow:hidden;transition:max-height .5s ease,padding .3s ease,opacity .3s ease;opacity:0}
.collapsible.open{max-height:2000px;padding-top:6px;opacity:1}

/* ===== í…Œì´ë¸” ===== */
.tablewrap{overflow:auto;background:#0f1526;border-radius:14px;padding:0 6px 6px 0;max-height:50vh;transition:background .3s}
:root.light .tablewrap{background:#eef1f7}
table{border-collapse:collapse;width:auto;min-width:100%;table-layout:auto}
thead th{position:sticky;top:0;z-index:2;background:#12203a;white-space:nowrap;transition:background .3s}
:root.light thead th{background:#d6deec}
th,td{padding:6px 8px;border-bottom:1px solid var(--line);text-align:right;font-size:13px;line-height:1.5;transition:border-color .3s}
th:first-child,td:first-child{text-align:center;padding-left:0;padding-right:4px}
th:nth-child(1){width:54px}
th:nth-child(2),th:nth-child(3),th:nth-child(4),th:nth-child(5){width:63px}
th:nth-child(6){width:72px}
th:nth-child(7){width:52px}

/* ===== Charts ===== */
.charts{margin-top:14px;display:grid;grid-template-columns:1fr;gap:12px}
.chart{background:#0f1526;border-radius:12px;padding:10px;transition:background .3s}
:root.light .chart{background:#eef1f7}
.chart h3{margin:0 0 8px;font-size:15px;color:var(--mut);font-weight:700}
.canvas-wrap{position:relative;width:100%;height:200px}
.canvas-wrap canvas{position:absolute;left:0;top:0;width:100%;height:100%}

/* í•˜ë‹¨ í•œ ì¤„ */
#foot{display:flex;align-items:center;justify-content:space-between;gap:8px;font-size:12px;color:var(--mut);margin-top:4px}
#foot > span{white-space:nowrap}

/* ===== ìƒë‹¨ ìš°ì¸¡: ì—°ê²° ë°°ì§€ & ë²„íŠ¼ ===== */
.header-actions{display:flex;gap:8px;align-items:center}
.badge{padding:8px 12px;border-radius:999px;border:1px solid var(--line);font-weight:700;font-size:14px}
.badge.ok{color:#fff;background:rgba(40,208,127,.14);border-color:rgba(40,208,127,.35)}
.badge.bad{color:#fff;background:rgba(255,107,107,.14);border-color:rgba(255,107,107,.35)}
.smallbtn{background:var(--btn-bg);border:1px solid var(--btn-border);color:var(--txt);padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:700}

/* ===== Wi-Fi ëª¨ë‹¬ ===== */
.backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);backdrop-filter:blur(2px);display:none;place-items:center;z-index:50}
.modal{width:min(92vw,520px);background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px}
.row{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
input[type="text"],input[type="password"]{width:100%;padding:10px 12px;background:#0e1526;color:var(--txt);border:1px solid var(--line);border-radius:10px}
:root.light input[type="text"],:root.light input[type="password"]{background:#eef1f7}
.modal .btns{display:flex;justify-content:flex-end;gap:8px}
.hint{color:var(--mut);font-size:12px}
</style>
</head>
<body>
<div class="wrap"><div class="card">
  <h1>
    ESP32 ì„¼ì„œ ëŒ€ì‹œë³´ë“œ
    <span class="header-actions">
      <span id="connBadge" class="badge bad">ì˜¤í”„ë¼ì¸</span>
      <button id="btnWifi" class="smallbtn">Wi-Fi ì„¤ì •</button>
      <span class="theme-toggle" id="themeToggle">ğŸŒ™</span>
    </span>
  </h1>
  <p class="mut">AHT25(ì˜¨/ìŠµ) + SCD42(ì˜¨/ìŠµ/COâ‚‚) Â· LEDì œì–´</p>

  <div id="banner" class="status">â€”</div>
  <div class="grid">
    <div class="tile"><div>AHT25 ì˜¨ë„</div><div id="aht_t" class="v">--.- Â°C</div></div>
    <div class="tile"><div>AHT25 ìŠµë„</div><div id="aht_h" class="v">-- %</div></div>
    <div class="tile"><div>SCD42 ì˜¨ë„</div><div id="scd_t" class="v">--.- Â°C</div></div>
    <div class="tile"><div>SCD42 ìŠµë„</div><div id="scd_h" class="v">-- %</div></div>
    <div class="tile"><div>COâ‚‚ ê³µê¸°</div><div id="scd_c" class="v">---- ppm</div></div>
  </div>

  <div class="led">
    <button id="on"  class="btn on">LED ON</button>
    <button id="off" class="btn off">LED OFF</button>
    <div id="led" class="status">LED: -</div>
  </div>

  <hr>
  <div class="toggle-row">
    <button class="btn toggle" id="toggleTable">ğŸ“‹ í…Œì´ë¸” ë³´ê¸°</button>
    <button class="btn toggle" id="toggleGraph">ğŸ“Š ê·¸ë˜í”„ ë³´ê¸°</button>
  </div>

  <div id="tableSection" class="collapsible">
    <div class="tablewrap">
      <table>
        <thead>
          <tr>
            <th>ì‹œê°„</th>
            <th>AHT&nbsp;Â°C</th>
            <th>AHT&nbsp;%</th>
            <th>SCD&nbsp;Â°C</th>
            <th>SCD&nbsp;%</th>
            <th>COâ‚‚</th>
            <th>LED</th>
          </tr>
        </thead>
        <tbody id="logtbl"></tbody>
      </table>
    </div>
  </div>

  <div id="graphSection" class="collapsible">
    <div class="charts">
      <div class="chart"><h3>ì˜¨ë„ (Â°C) â€” ìµœê·¼ 60ë¶„</h3><div class="canvas-wrap"><canvas id="chTemp"></canvas></div></div>
      <div class="chart"><h3>ìŠµë„ (%) â€” ìµœê·¼ 60ë¶„</h3><div class="canvas-wrap"><canvas id="chHum"></canvas></div></div>
      <div class="chart"><h3>COâ‚‚ (ppm) â€” ìµœê·¼ 60ë¶„</h3><div class="canvas-wrap"><canvas id="chCO2"></canvas></div></div>
    </div>
  </div>

  <hr>
  <div class="status" id="raw">â€”</div>
  <div id="foot"><span id="rssi">RSSI: -- [dBm]</span><span id="ts">â€”</span></div>
</div></div>

<!-- Wi-Fi ì„¤ì • ëª¨ë‹¬ -->
<div id="wifiBackdrop" class="backdrop">
  <div class="modal">
    <h3 style="margin:0 0 8px 0">Wi-Fi ì„¤ì •</h3>
    <p class="mut small" style="margin-top:0">SSIDì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ë©´ ì¥ì¹˜ê°€ ì ì‹œ í›„ í•´ë‹¹ APë¡œ ì¬ì—°ê²°í•©ë‹ˆë‹¤.</p>
    <div class="row">
      <label class="small mut">SSID</label>
      <input id="inSsid" type="text" placeholder="ì˜ˆ: Backhome">
    </div>
    <div class="row">
      <label class="small mut">ë¹„ë°€ë²ˆí˜¸</label>
      <input id="inPass" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸">
    </div>
    <div id="wifiHint" class="hint"></div>
    <div class="btns">
      <button id="btnWifiCancel" class="smallbtn">ì·¨ì†Œ</button>
      <button id="btnWifiSave" class="smallbtn">ì €ì¥ & ì ìš©</button>
    </div>
  </div>
</div>

<script>
/* ===== ìƒìˆ˜/í‚¤ ===== */
const LS_LAST_STATUS = 'esp32_last_status';
const LS_BASE       = 'base';
const fastMs = 3000, maxRows = 60;

/* ===== Theme ===== */
const themeToggle=document.getElementById('themeToggle');
function applyTheme(t){
  document.documentElement.classList.toggle('light', t==='light');
  themeToggle.textContent = (t==='light')?'â˜€ï¸':'ğŸŒ™';
}
applyTheme(localStorage.getItem('theme')||'dark');
themeToggle.onclick=()=>{const t=document.documentElement.classList.contains('light')?'dark':'light';applyTheme(t);localStorage.setItem('theme',t);};

/* ===== BASE (ì—”ë“œí¬ì¸íŠ¸) ===== */
const BASE = (()=>{ const saved=localStorage.getItem(LS_BASE); return saved?saved.replace(/\/$/,''):'http://esp32.local'; })();
const EP = {
  status : ['/api/status','/status','/readings','/get','/api/readings'],
  history60: ['/api/history?limit=60','/history?limit=60','/api/history','/history','/logs'],
  history1 : ['/api/history?limit=1','/history?limit=1','/api/history','/history'],
  ledOn  : ['/api/led?state=on','/led/on','/api/led/on','/set?led=1'],
  ledOff : ['/api/led?state=off','/led/off','/api/led/off','/set?led=0'],
};
async function fetchFirstJson(cands,opt={}){for(const u of cands){const url=/^https?:\/\//.test(u)?u:(BASE+u);try{const r=await fetch(url,{...opt,cache:'no-store'});if(!r.ok)continue;return await r.json();}catch(e){}}throw new Error('ëª¨ë“  ê²½ë¡œ ì‹¤íŒ¨');}

/* ===== DOM ===== */
const $=id=>document.getElementById(id);
const connBadge=$('connBadge'), banner=$('banner');
const aht_t=$('aht_t'), aht_h=$('aht_h'), scd_t=$('scd_t'), scd_h=$('scd_h'), scd_c=$('scd_c');
const ledTxt=$('led'), rssiTxt=$('rssi'), tsTxt=$('ts');
const tableBody=$('logtbl');

/* ===== í‘œì‹œ/ë°°ì§€ ===== */
function setConnBadge(ok){
  connBadge.textContent = ok ? 'ì—°ê²°ë¨' : 'ì˜¤í”„ë¼ì¸';
  connBadge.classList.toggle('ok', ok);
  connBadge.classList.toggle('bad', !ok);
}
function fmtNow(){const d=new Date();const p=n=>String(n).padStart(2,'0');return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())}`;}
function tickClock(){ tsTxt.textContent = fmtNow(); }

/* ===== ìºì‹œ ì¦‰ì‹œ í‘œì‹œ ===== */
function renderFromCache(){
  const raw = localStorage.getItem(LS_LAST_STATUS);
  if(!raw) return false;
  try{
    const s = JSON.parse(raw);
    applyStatus(s, /*fromCache*/true);
    return true;
  }catch(_){ return false; }
}

/* ===== ìƒíƒœ ì ìš© ===== */
function applyStatus(s, fromCache=false){
  const aT = Number(s.aht_t), aH = Number(s.aht_h);
  const sT = Number(s.scd_t), sH = Number(s.scd_h);
  const co2= Number(s.co2);
  const led = (s.led=='1'||s.led===1||s.led===true||s.led==='on');

  if (!Number.isNaN(aT)) aht_t.textContent = aT.toFixed(1)+' Â°C';
  if (!Number.isNaN(aH)) aht_h.textContent = Math.round(aH)+' %';
  if (!Number.isNaN(sT)) scd_t.textContent = sT.toFixed(1)+' Â°C';
  if (!Number.isNaN(sH)) scd_h.textContent = Math.round(sH)+' %';
  if (!Number.isNaN(co2) && co2>0) scd_c.textContent = co2+' ppm';
  ledTxt.textContent = 'LED: '+(led?'ON':'OFF');

  if (typeof s.rssi !== 'undefined') rssiTxt.textContent = `RSSI: ${s.rssi} [dBm]`;
  tickClock();

  // ìºì‹œ ì €ì¥(ì‹¤ì‹œê°„ ì‘ë‹µì—ì„œë§Œ)
  if (!fromCache) localStorage.setItem(LS_LAST_STATUS, JSON.stringify(s));

  banner.textContent='AHT25/SCD42 ì—°ê²° OK';
  setConnBadge(true);
}

/* ===== íˆìŠ¤í† ë¦¬ ===== */
function addRowTop(obj, ts){
  const d=ts?new Date(ts):new Date();
  const hh=String(d.getHours()).padStart(2,'0');
  const mm=String(d.getMinutes()).padStart(2,'0');
  const tr=document.createElement('tr');
  tr.innerHTML=`
    <td>${hh}:${mm}</td>
    <td>${Number(obj.aht_t).toFixed(1)}</td>
    <td>${Math.round(Number(obj.aht_h))}</td>
    <td>${Number(obj.scd_t).toFixed(1)}</td>
    <td>${Math.round(Number(obj.scd_h))}</td>
    <td>${obj.co2}</td>
    <td>${(obj.led?'ON':'OFF')}</td>`;
  if(tableBody.firstChild) tableBody.insertBefore(tr, tableBody.firstChild); else tableBody.appendChild(tr);
  while(tableBody.rows.length>maxRows) tableBody.deleteRow(tableBody.rows.length-1);
}
async function loadHistory60(){
  try{
    const list=await fetchFirstJson(EP.history60);
    tableBody.innerHTML='';
    const now=Date.now();
    for(const it of list){
      const ts=it.timestamp?new Date(it.timestamp):new Date(now-(it.age||0)*60000);
      addRowTop({
        aht_t:it.aht_t??it.aht_temp??it.temp,
        aht_h:it.aht_h??it.aht_hum ??it.hum,
        scd_t:it.scd_t??it.scd_temp??it.st,
        scd_h:it.scd_h??it.scd_hum ??it.sh,
        co2  :it.co2  ??it.scd_co2 ??it.ppm,
        led  :(it.led=='1'||it.led===1||it.led==='on')
      }, ts);
    }
  }catch(_){}
}

/* ===== í´ë§ ===== */
async function refreshFast(){
  try{
    const s=await fetchFirstJson(EP.status);
    applyStatus(s, /*fromCache*/false);
  }catch(e){
    banner.textContent='í†µì‹  ì˜¤ë¥˜: '+e.message;
    setConnBadge(false);
    tickClock();
  }
}

/* ===== LED ì œì–´ ===== */
document.getElementById('on').onclick  = async()=>{try{await fetch(BASE+EP.ledOn[0], {cache:'no-store'});}catch(_){ } refreshFast();};
document.getElementById('off').onclick = async()=>{try{await fetch(BASE+EP.ledOff[0],{cache:'no-store'});}catch(_){ } refreshFast();};

/* ===== Wi-Fi ëª¨ë‹¬ ===== */
const bd=document.getElementById('wifiBackdrop');
const openModal = ()=>{ document.getElementById('wifiHint').textContent=''; bd.style.display='grid'; };
const closeModal= ()=>{ bd.style.display='none'; };
document.getElementById('btnWifi').onclick=openModal;
document.getElementById('btnWifiCancel').onclick=closeModal;
document.getElementById('btnWifiSave').onclick=async ()=>{
  const ss=document.getElementById('inSsid').value.trim();
  const pw=document.getElementById('inPass').value;
  const hint=document.getElementById('wifiHint');
  if(!ss||!pw){ hint.textContent='SSID/ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.'; return; }
  try{
    const r=await fetch(BASE+'/api/wifi',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({ssid:ss,pass:pw})});
    if(!r.ok) throw new Error('HTTP '+r.status);
    hint.textContent='ì „ì†¡ ì™„ë£Œ. ì¥ì¹˜ê°€ ì¬ì—°ê²° ì¤‘ì…ë‹ˆë‹¤â€¦';
    setTimeout(closeModal, 900);
  }catch(e){ hint.textContent='ì „ì†¡ ì‹¤íŒ¨: '+e.message; }
};

/* ===== ë¶€íŠ¸ ===== */
(async()=>{
  // 1) ìºì‹œ ë¨¼ì € ì¦‰ì‹œ ë Œë”(ê¹œë¹¡ì„ ë°©ì§€)
  renderFromCache();

  // 2) ìµœì‹ ê°’ ìš”ì²­
  await refreshFast();

  // 3) í…Œì´ë¸”/ê·¸ë˜í”„ìš© íˆìŠ¤í† ë¦¬(ì´ˆê¸° 1íšŒ)
  loadHistory60();

  // 4) ì£¼ê¸° í´ë§
  setInterval(refreshFast, fastMs);
  setInterval(()=>{ tsTxt.textContent = fmtNow(); }, 1000);
})();
</script>
</body>
</html>
