<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ESP32 ì„¼ì„œ ëŒ€ì‹œë³´ë“œ</title>

<style>
:root{
  --bg:#0b0d11; --card:#12151b; --txt:#e9edf3;
  --mut:#9aa3ad; --btn-bg:#171b22; --btn-border:#2a3140; --ok:#19c37d; --dim:#3a4252;
}
*{box-sizing:border-box}
html,body{margin:0;padding:0;background:var(--bg);color:var(--txt);font-family:system-ui,apple sd gothic neo,Segoe UI,Roboto,Arial,HelveticaNeue,Helvetica,sans-serif}
.wrap{max-width:980px;margin:24px auto;padding:0 16px}
.card{background:var(--card);border-radius:16px;padding:18px 18px 20px;box-shadow:0 8px 30px rgba(0,0,0,.25)}
.mut{color:var(--mut)}

.head{display:flex;align-items:center;justify-content:space-between;gap:12px}
.actions{display:flex;align-items:center;gap:8px;flex-shrink:0}
.theme-toggle{cursor:pointer;font-size:20px;user-select:none}
.btn{background:var(--btn-bg);border:1px solid var(--btn-border);color:var(--txt);padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:700}
.btn.on{border-color:#1e8e5a}
.btn.dim{opacity:.85}
.btn.wifi{font-weight:800}

.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px;margin-top:12px}
.tile{background:#0f1217;border:1px solid #1c2230;border-radius:12px;padding:12px}

.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:999}
.modal{background:var(--card);border-radius:14px;padding:16px;min-width:280px;max-width:90vw;box-shadow:0 10px 30px rgba(0,0,0,.35)}
.modal h3{margin:0 0 10px}
.modal .row{display:flex;flex-direction:column;gap:6px;margin:8px 0}
.modal input{background:transparent;border:1px solid var(--btn-border);color:var(--txt);padding:10px;border-radius:10px;outline:none}
.modal .acts{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
.modal .acts .btn{min-width:auto;padding:10px 12px}
.modal.show{display:flex}

/* ë°ëª¨ìš© í‘œ/ë²„íŠ¼ */
.table{width:100%;border-collapse:collapse}
.table th,.table td{border-bottom:1px solid #202838;padding:8px 6px;text-align:left}
.badge{display:inline-block;padding:4px 8px;border-radius:12px;border:1px solid #263147;background:#111722}
.badge.ok{border-color:#19533b;background:#0f1e19;color:#7fe5b9}
</style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <div class="head">
      <h1 style="margin:0">ESP32 ì„¼ì„œ ëŒ€ì‹œë³´ë“œ</h1>
      <div class="actions">
        <button id="btnWifi" class="btn wifi">Wi-Fi</button>
        <span class="theme-toggle" id="themeToggle">ğŸŒ™</span>
      </div>
    </div>

    <p class="mut">AHT25(ì˜¨/ìŠµ) + SCD42(ì˜¨/ìŠµ/COâ‚‚) Â· LEDì œì–´</p>

    <div class="grid">
      <div class="tile">
        <h3 style="margin:0 0 8px">ì¥ì¹˜ ìƒíƒœ</h3>
        <table class="table">
          <tbody id="statusBody">
            <tr><th>Wi-Fi</th><td id="wifiState"><span class="badge">í™•ì¸ ì¤‘â€¦</span></td></tr>
            <tr><th>AHT ì˜¨ë„</th><td id="ahtT">-</td></tr>
            <tr><th>AHT ìŠµë„</th><td id="ahtH">-</td></tr>
            <tr><th>SCD ì˜¨ë„</th><td id="scdT">-</td></tr>
            <tr><th>SCD ìŠµë„</th><td id="scdH">-</td></tr>
            <tr><th>COâ‚‚</th><td id="co2">-</td></tr>
            <tr><th>RSSI</th><td id="rssi">-</td></tr>
          </tbody>
        </table>
      </div>
      <div class="tile">
        <h3 style="margin:0 0 8px">LED ì œì–´</h3>
        <div style="display:flex;gap:8px">
          <button id="ledOn"  class="btn on">LED ON</button>
          <button id="ledOff" class="btn">LED OFF</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Wi-Fi ì—°ê²° ëª¨ë‹¬ -->
<div id="wifiModal" class="modal-backdrop">
  <div class="modal">
    <h3>Wi-Fi ì—°ê²°</h3>
    <div class="row">
      <label>SSID</label>
      <input id="inSsid" placeholder="ë„¤íŠ¸ì›Œí¬ ì´ë¦„">
    </div>
    <div class="row">
      <label>ë¹„ë°€ë²ˆí˜¸</label>
      <input id="inPw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸(í•„ìš” ì‹œ)">
    </div>
    <div id="wifiHint" class="mut">í˜„ì¬ ìƒíƒœ í™•ì¸ ì¤‘â€¦</div>
    <div class="acts">
      <button class="btn dim" id="wifiCancel">ì·¨ì†Œ</button>
      <button class="btn on"  id="wifiConnect">ì—°ê²°</button>
    </div>
  </div>
</div>

<script>
// ===== ê¸°ë³¸ ì„¤ì • =====
const BASE = ""; // ê°™ì€ í˜¸ìŠ¤íŠ¸ì—ì„œ ì œê³µ ì‹œ ë¹ˆ ë¬¸ìì—´

// í…Œë§ˆ í† ê¸€(ì› ì½”ë“œ ëŠë‚Œ ìœ ì§€)
const themeToggle = document.getElementById('themeToggle');
let dark = true;
themeToggle.onclick = () => {
  dark = !dark;
  document.documentElement.style.filter = dark ? "" : "invert(1) hue-rotate(180deg)";
  themeToggle.textContent = dark ? "ğŸŒ™" : "â˜€ï¸";
};

// ìƒíƒœ ê°±ì‹ 
async function refreshFast(){
  try{
    const r = await fetch(BASE + '/api/status', {cache:'no-store'});
    const j = await r.json();
    document.getElementById('ahtT').textContent = j.aht_t?.toFixed ? j.aht_t.toFixed(1)+' Â°C' : j.aht_t;
    document.getElementById('ahtH').textContent = j.aht_h?.toFixed ? j.aht_h.toFixed(1)+' %'   : j.aht_h;
    document.getElementById('scdT').textContent = j.scd_t?.toFixed ? j.scd_t.toFixed(1)+' Â°C' : j.scd_t;
    document.getElementById('scdH').textContent = j.scd_h?.toFixed ? j.scd_h.toFixed(1)+' %'   : j.scd_h;
    document.getElementById('co2').textContent  = j.co2;
    document.getElementById('rssi').textContent = j.rssi + ' dBm';
  }catch(e){
    // ignore
  }
  try{
    const s = await (await fetch(BASE + '/api/wifi/status', {cache:'no-store'})).json();
    const el = document.getElementById('wifiState');
    el.innerHTML = s.connected
      ? `<span class="badge ok">ì—°ê²°ë¨: ${s.ssid} (${s.ip})</span>`
      : `<span class="badge">ë¯¸ì—°ê²°</span>`;
  }catch(e){}
}
refreshFast();
setInterval(refreshFast, 5000);

// LED
document.getElementById('ledOn').onclick  = ()=>fetch(BASE + '/api/led/on');
document.getElementById('ledOff').onclick = ()=>fetch(BASE + '/api/led/off');

// ===== Wi-Fi ëª¨ë‹¬ =====
const mBackdrop = document.getElementById('wifiModal');
const btnWifi   = document.getElementById('btnWifi');
const inSsid    = document.getElementById('inSsid');
const inPw      = document.getElementById('inPw');
const btnWCancel= document.getElementById('wifiCancel');
const btnWConn  = document.getElementById('wifiConnect');
const wifiHint  = document.getElementById('wifiHint');

function openWifiModal(){
  mBackdrop.classList.add('show');
  fetch(BASE + '/api/wifi/status', {cache:'no-store'})
    .then(r=>r.json()).then(s=>{
      wifiHint.textContent = s.connected ? `ì—°ê²°ë¨: ${s.ssid} (${s.ip})` : 'ë¯¸ì—°ê²°';
      if(!s.connected && inSsid.value===''){ inSsid.focus(); }
    }).catch(_=>{ wifiHint.textContent='ìƒíƒœ ì¡°íšŒ ì‹¤íŒ¨'; });
}
function closeWifiModal(){ mBackdrop.classList.remove('show'); }

btnWifi.onclick    = openWifiModal;
btnWCancel.onclick = closeWifiModal;
mBackdrop.addEventListener('click', (e)=>{ if(e.target===mBackdrop) closeWifiModal(); });

btnWConn.onclick = async ()=>{
  const ssid = inSsid.value.trim();
  const password = inPw.value;
  if(!ssid){ wifiHint.textContent='SSIDë¥¼ ì…ë ¥í•˜ì„¸ìš”.'; inSsid.focus(); return; }
  wifiHint.textContent='ì—°ê²° ì‹œë„ ì¤‘â€¦';
  try{
    const r = await fetch(BASE + '/api/wifi/connect', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ssid, password}),
    });
    const j = await r.json();
    if(j.ok){
      wifiHint.textContent = `ì—°ê²°ë¨: ${j.ssid} (${j.ip})`;
      refreshFast();
      setTimeout(closeWifiModal, 800);
    }else{
      wifiHint.textContent = 'ì—°ê²° ì‹¤íŒ¨. SSID/ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.';
    }
  }catch(e){
    wifiHint.textContent = 'ì—°ê²° ì˜¤ë¥˜: ' + e.message;
  }
};
</script>
</body>
</html>
