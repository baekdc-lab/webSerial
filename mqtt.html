<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ESP32 ì„¼ì„œ ëŒ€ì‹œë³´ë“œ</title>
<style>
:root{--bg:#0b1020;--card:#131a2b;--txt:#e8eefc;--mut:#9fb2d7;--line:#22314f;--btn-bg:#1b2b4a;--btn-border:#2c3e63;--ok:#28d07f;--bad:#ff6b6b}
:root.light{--bg:#f5f7fa;--card:#ffffff;--txt:#0b1020;--mut:#5a6b8a;--line:#ccd4e0;--btn-bg:#e4e8ef;--btn-border:#b0bacb}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--txt);font:16px/1.5 system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,sans-serif}
.wrap{max-width:900px;margin:20px auto;padding:0 12px}
.card{background:var(--card);border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
h1{margin:0 0 8px;font-size:26px;font-weight:800;display:flex;justify-content:space-between;align-items:center}
.mut{color:var(--mut);margin:0 0 12px}
hr{border:0;border-top:1px solid var(--line);margin:14px 0}

/* ìƒë‹¨ ìš°ì¸¡ */
.header-actions{display:flex;gap:8px;align-items:center}
.badge{padding:8px 12px;border-radius:999px;border:1px solid var(--line);font-weight:700;font-size:14px}
.badge.ok{color:#fff;background:rgba(40,208,127,.14);border-color:rgba(40,208,127,.35)}
.badge.bad{color:#fff;background:rgba(255,107,107,.14);border-color:rgba(255,107,107,.35)}
.smallbtn{background:var(--btn-bg);border:1px solid var(--btn-border);color:var(--txt);padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:700}
.theme-toggle{cursor:pointer;font-size:22px;user-select:none}

/* KPI */
.grid{display:grid;grid-template-columns:repeat(5,minmax(0,1fr));gap:12px;margin-top:6px}
.tile{background:#0f1526;border-radius:12px;padding:12px;text-align:center;min-height:76px}
:root.light .tile{background:#eef1f7}
.v{font-size:22px;font-weight:800;margin-top:4px}

/* LED */
.led{display:flex;align-items:center;gap:12px;margin-top:12px;flex-wrap:wrap}
.btn{border:0;color:#fff;padding:12px 14px;border-radius:12px;cursor:pointer;font-weight:800;min-width:98px;font-size:15px}
.btn.on{background:#2d6bff}.btn.off{background:#32405e}

/* ì ‘í˜ */
.collapsible{max-height:0;overflow:hidden;transition:max-height .45s ease,opacity .3s ease;opacity:0}
.collapsible.open{max-height:2000px;opacity:1}
.btn.toggle{background:var(--btn-bg);border:1px solid var(--btn-border);color:var(--txt);min-width:120px}

/* í…Œì´ë¸” */
.tablewrap{overflow:auto;background:#0f1526;border-radius:14px;padding:0 6px 6px 0;max-height:50vh}
:root.light .tablewrap{background:#eef1f7}
table{border-collapse:collapse;width:auto;min-width:100%}
thead th{position:sticky;top:0;background:#12203a}
:root.light thead th{background:#d6deec}
th,td{padding:6px 8px;border-bottom:1px solid var(--line);text-align:right;font-size:13px}
th:first-child,td:first-child{text-align:center}
th:nth-child(1){width:54px} th:nth-child(2),th:nth-child(3),th:nth-child(4),th:nth-child(5){width:63px}
th:nth-child(6){width:72px} th:nth-child(7){width:52px}

/* ì°¨íŠ¸ */
.charts{margin-top:14px;display:grid;grid-template-columns:1fr;gap:12px}
.chart{background:#0f1526;border-radius:12px;padding:10px}
:root.light .chart{background:#eef1f7}
.chart h3{margin:0 0 8px;font-size:15px;color:var(--mut);font-weight:700}
.canvas-wrap{position:relative;width:100%;height:200px}
.canvas-wrap canvas{position:absolute;left:0;top:0;width:100%;height:100%}

/* í•˜ë‹¨ í•œ ì¤„ */
#foot{display:flex;align-items:center;justify-content:space-between;gap:8px;font-size:12px;color:var(--mut);margin-top:4px}
#foot > span{white-space:nowrap}

/* Wi-Fi ëª¨ë‹¬ */
.backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);backdrop-filter:blur(2px);display:none;place-items:center;z-index:50}
.modal{width:min(92vw,520px);background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px}
.row{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
input[type="text"],input[type="password"]{width:100%;padding:10px 12px;background:#0e1526;color:var(--txt);border:1px solid var(--line);border-radius:10px}
:root.light input[type="text"],:root.light input[type="password"]{background:#eef1f7}
.modal .btns{display:flex;justify-content:flex-end;gap:8px}
.hint{color:var(--mut);font-size:12px}
</style>
</head>
<body>
<div class="wrap"><div class="card">
  <h1>
    ESP32 ì„¼ì„œ ëŒ€ì‹œë³´ë“œ
    <span class="header-actions">
      <span id="connBadge" class="badge bad">ì˜¤í”„ë¼ì¸</span>
      <button id="btnWifi" class="smallbtn">Wi-Fi ì„¤ì •</button>
      <span class="theme-toggle" id="themeToggle">ğŸŒ™</span>
    </span>
  </h1>
  <p class="mut">AHT25(ì˜¨/ìŠµ) + SCD42(ì˜¨/ìŠµ/COâ‚‚) Â· LEDì œì–´</p>

  <!-- ìƒíƒœì¤„(---) ì œê±°ë¨ -->

  <div class="grid">
    <div class="tile"><div>AHT25 ì˜¨ë„</div><div id="aht_t" class="v">--.- Â°C</div></div>
    <div class="tile"><div>AHT25 ìŠµë„</div><div id="aht_h" class="v">-- %</div></div>
    <div class="tile"><div>SCD42 ì˜¨ë„</div><div id="scd_t" class="v">--.- Â°C</div></div>
    <div class="tile"><div>SCD42 ìŠµë„</div><div id="scd_h" class="v">-- %</div></div>
    <div class="tile"><div>COâ‚‚ ê³µê¸°</div><div id="scd_c" class="v">---- ppm</div></div>
  </div>

  <div class="led">
    <button id="on"  class="btn on">LED ON</button>
    <button id="off" class="btn off">LED OFF</button>
    <div id="led" class="mut">LED: -</div>
  </div>

  <hr>
  <div class="toggle-row">
    <button class="btn toggle" id="toggleTable">ğŸ“‹ í…Œì´ë¸” ë³´ê¸°</button>
    <button class="btn toggle" id="toggleGraph">ğŸ“Š ê·¸ë˜í”„ ë³´ê¸°</button>
  </div>

  <div id="tableSection" class="collapsible">
    <div class="tablewrap">
      <table>
        <thead>
          <tr>
            <th>ì‹œê°„</th>
            <th>AHT&nbsp;Â°C</th>
            <th>AHT&nbsp;%</th>
            <th>SCD&nbsp;Â°C</th>
            <th>SCD&nbsp;%</th>
            <th>COâ‚‚</th>
            <th>LED</th>
          </tr>
        </thead>
        <tbody id="logtbl"></tbody>
      </table>
    </div>
  </div>

  <div id="graphSection" class="collapsible">
    <div class="charts">
      <div class="chart"><h3>ì˜¨ë„ (Â°C) â€” ìµœê·¼ 60ë¶„</h3><div class="canvas-wrap"><canvas id="chTemp"></canvas></div></div>
      <div class="chart"><h3>ìŠµë„ (%) â€” ìµœê·¼ 60ë¶„</h3><div class="canvas-wrap"><canvas id="chHum"></canvas></div></div>
      <div class="chart"><h3>COâ‚‚ (ppm) â€” ìµœê·¼ 60ë¶„</h3><div class="canvas-wrap"><canvas id="chCO2"></canvas></div></div>
    </div>
  </div>

  <hr>
  <div id="foot"><span id="rssi">RSSI: -- [dBm]</span><span id="ts">â€”</span></div>
</div></div>

<!-- Wi-Fi ì„¤ì • ëª¨ë‹¬ -->
<div id="wifiBackdrop" class="backdrop">
  <div class="modal">
    <h3 style="margin:0 0 8px 0">Wi-Fi ì„¤ì •</h3>
    <p class="mut small" style="margin-top:0">SSIDì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ë©´ ì¥ì¹˜ê°€ ì ì‹œ í›„ í•´ë‹¹ APë¡œ ì¬ì—°ê²°í•©ë‹ˆë‹¤.</p>
    <div class="row"><label class="small mut">SSID</label><input id="inSsid" type="text" placeholder="ì˜ˆ: Backhome"></div>
    <div class="row"><label class="small mut">ë¹„ë°€ë²ˆí˜¸</label><input id="inPass" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸"></div>
    <div id="wifiHint" class="hint"></div>
    <div class="btns"><button id="btnWifiCancel" class="smallbtn">ì·¨ì†Œ</button><button id="btnWifiSave" class="smallbtn">ì €ì¥ & ì ìš©</button></div>
  </div>
</div>

<script>
/* ===== ê¸°ë³¸ ===== */
const LS_LAST_STATUS='esp32_last_status', LS_BASE='base';
const BASE=(localStorage.getItem(LS_BASE)||'http://esp32.local').replace(/\/$/,'');
const fastMs=3000, maxRows=60;
const EP={
  status:['/api/status','/status','/readings','/get','/api/readings'],
  history60:['/api/history?limit=60','/history?limit=60','/api/history','/history','/logs'],
  history1:['/api/history?limit=1','/history?limit=1','/api/history','/history'],
  ledOn:['/api/led?state=on','/set?led=1','/led/on'],
  ledOff:['/api/led?state=off','/set?led=0','/led/off'],
};
async function fetchFirstJson(cands,opt={}){for(const u of cands){const url=/^https?:\/\//.test(u)?u:(BASE+u);try{const r=await fetch(url,{...opt,cache:'no-store'});if(!r.ok)continue;return await r.json();}catch(_){}}throw new Error('ëª¨ë“  ê²½ë¡œ ì‹¤íŒ¨');}
async function sendFirst(cands){ // POST ë¨¼ì € â†’ ì‹¤íŒ¨ ì‹œ GET í´ë°±
  for(const path of cands){
    const url=BASE+path;
    try{ let r=await fetch(url,{method:'POST'}); if(r.ok) return await r.json(); }catch(_){}
    try{ let r=await fetch(url); if(r.ok) return await r.json(); }catch(_){}
  }
  throw new Error('ìš”ì²­ ì‹¤íŒ¨');
}

/* ===== DOM ===== */
const $=id=>document.getElementById(id);
const aht_t=$('aht_t'), aht_h=$('aht_h'), scd_t=$('scd_t'), scd_h=$('scd_h'), scd_c=$('scd_c');
const ledTxt=$('led'), rssiTxt=$('rssi'), tsTxt=$('ts');
const connBadge=$('connBadge'), tableBody=$('logtbl');

/* ===== í…Œë§ˆ ===== */
const themeToggle=$('themeToggle');
function applyTheme(t){document.documentElement.classList.toggle('light',t==='light');themeToggle.textContent=(t==='light')?'â˜€ï¸':'ğŸŒ™'}
applyTheme(localStorage.getItem('theme')||'dark');
themeToggle.onclick=()=>{const t=document.documentElement.classList.contains('light')?'dark':'light';applyTheme(t);localStorage.setItem('theme',t);};

/* ===== í‘œì‹œ ===== */
function setConnBadge(ok){connBadge.textContent=ok?'ì—°ê²°ë¨':'ì˜¤í”„ë¼ì¸';connBadge.classList.toggle('ok',ok);connBadge.classList.toggle('bad',!ok);}
function fmtNow(){const d=new Date();const p=n=>String(n).padStart(2,'0');return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())}`;}
function tickClock(){ tsTxt.textContent=fmtNow(); }

/* ===== ìºì‹œ ë¨¼ì € ë Œë” ===== */
(function renderFromCache(){
  const raw=localStorage.getItem(LS_LAST_STATUS);
  if(!raw) return;
  try{ applyStatus(JSON.parse(raw), true); }catch(_){}
})();

function applyStatus(s,fromCache=false){
  const aT=Number(s.aht_t), aH=Number(s.aht_h), sT=Number(s.scd_t), sH=Number(s.scd_h), co=Number(s.co2);
  const led=(s.led=='1'||s.led===1||s.led===true||s.led==='on');
  if(!Number.isNaN(aT)) aht_t.textContent=aT.toFixed(1)+' Â°C';
  if(!Number.isNaN(aH)) aht_h.textContent=Math.round(aH)+' %';
  if(!Number.isNaN(sT)) scd_t.textContent=sT.toFixed(1)+' Â°C';
  if(!Number.isNaN(sH)) scd_h.textContent=Math.round(sH)+' %';
  if(!Number.isNaN(co)&&co>0) scd_c.textContent=co+' ppm';
  ledTxt.textContent='LED: '+(led?'ON':'OFF');
  if(typeof s.rssi!=='undefined') rssiTxt.textContent=`RSSI: ${s.rssi} [dBm]`;
  setConnBadge(true); tickClock();
  if(!fromCache) localStorage.setItem(LS_LAST_STATUS, JSON.stringify(s));
}

/* ===== í´ë§ ===== */
async function refreshFast(){
  try{ const s=await fetchFirstJson(EP.status); applyStatus(s,false); }
  catch(e){ setConnBadge(false); tickClock(); }
}

/* ===== LED ì œì–´: POSTâ†’GET í´ë°± & ì—¬ëŸ¬ ê²½ë¡œ ì‹œë„ ===== */
$('on').onclick  = async()=>{try{const js=await sendFirst(EP.ledOn);  applyStatus(js,false);}catch(_){setConnBadge(false)}};
$('off').onclick = async()=>{try{const js=await sendFirst(EP.ledOff); applyStatus(js,false);}catch(_){setConnBadge(false)}};

/* ===== í…Œì´ë¸”/ê·¸ë˜í”„ í† ê¸€ ===== */
const secTable=$('tableSection'), secGraph=$('graphSection');
$('toggleTable').onclick=()=>{secTable.classList.toggle('open');};
$('toggleGraph').onclick=()=>{secGraph.classList.toggle('open'); if(secGraph.classList.contains('open')) renderAllCharts();};

/* ===== íˆìŠ¤í† ë¦¬ ===== */
function addRowTop(obj, ts){
  const d=ts?new Date(ts):new Date();
  const hh=String(d.getHours()).padStart(2,'0'), mm=String(d.getMinutes()).padStart(2,'0');
  const tr=document.createElement('tr');
  tr.innerHTML=`<td>${hh}:${mm}</td>
    <td>${Number(obj.aht_t).toFixed(1)}</td>
    <td>${Math.round(Number(obj.aht_h))}</td>
    <td>${Number(obj.scd_t).toFixed(1)}</td>
    <td>${Math.round(Number(obj.scd_h))}</td>
    <td>${obj.co2}</td>
    <td>${(obj.led?'ON':'OFF')}</td>`;
  if(tableBody.firstChild) tableBody.insertBefore(tr, tableBody.firstChild); else tableBody.appendChild(tr);
  while(tableBody.rows.length>maxRows) tableBody.deleteRow(tableBody.rows.length-1);
}
async function loadHistory60(){
  try{
    const list=await fetchFirstJson(EP.history60);
    tableBody.innerHTML=''; const now=Date.now();
    for(const it of list){
      const ts=it.timestamp?new Date(it.timestamp):new Date(now-(it.age||0)*60000);
      addRowTop({
        aht_t:it.aht_t??it.aht_temp??it.temp,
        aht_h:it.aht_h??it.aht_hum ??it.hum,
        scd_t:it.scd_t??it.scd_temp??it.st,
        scd_h:it.scd_h??it.scd_hum ??it.sh,
        co2  :it.co2  ??it.scd_co2 ??it.ppm,
        led  :(it.led=='1'||it.led===1||it.led==='on')
      }, ts);
    }
  }catch(_){}
}

/* ===== ì°¨íŠ¸ ===== */
let histBuf=[];
function normalizeRec(o){return{aht_t:Number(o.aht_t??o.aht_temp??o.temp)||NaN,aht_h:Number(o.aht_h??o.aht_hum??o.hum)||NaN,scd_t:Number(o.scd_t??o.scd_temp??o.st)||NaN,scd_h:Number(o.scd_h??o.scd_hum??o.sh)||NaN,co2:Number(o.co2??o.scd_co2??o.ppm)||NaN};}
async function refreshLogOne(){try{const one=await fetchFirstJson(EP.history1);const it=Array.isArray(one)?one[0]:one;if(!it)return;addRowTop(it);histBuf.push(normalizeRec(it));if(histBuf.length>60)histBuf.shift();renderAllCharts();}catch(_){}}
const dpr=()=>window.devicePixelRatio||1;
function prepCanvas(cv){const r=cv.getBoundingClientRect();cv.width=Math.floor(r.width*dpr());cv.height=Math.floor(r.height*dpr());const ctx=cv.getContext('2d');ctx.setTransform(dpr(),0,0,dpr(),0,0);return ctx;}
function drawChart(cv, series, opts={}){const ctx=prepCanvas(cv);const W=cv.clientWidth,H=cv.clientHeight;const padL=38,padR=10,padT=opts.legend?32:10,padB=26,plotW=W-padL-padR,plotH=H-padT-padB;const light=document.documentElement.classList.contains('light');ctx.clearRect(0,0,W,H);ctx.fillStyle=light?'#eef1f7':'#0f1526';ctx.fillRect(0,0,W,H);if(opts.legend){ctx.font='12px system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,sans-serif';ctx.textAlign='left';ctx.textBaseline='middle';let x=padL,y=16;const cols=['#7aa0ff','#ff9a7a','#7affb0'];series.forEach((s,i)=>{ctx.fillStyle=s.color||cols[i%cols.length];ctx.fillRect(x,y-3,14,6);ctx.fillStyle=light?'#5a6b8a':'#9fb2d7';ctx.fillText('  '+s.name,x+18,y);x+=18+ctx.measureText('  '+s.name).width+14;});}
ctx.strokeStyle=light?'#ccd4e0':'#22314f';ctx.beginPath();for(let g=0;g<=4;g++){const y=padT+plotH*g/4;ctx.moveTo(padL,y);ctx.lineTo(padL+plotW,y);}for(let m=0;m<=60;m+=10){const x=padL+plotW*(m/60);ctx.moveTo(x,padT);ctx.lineTo(x,padT+plotH);}ctx.stroke();ctx.fillStyle=light?'#5a6b8a':'#9fb2d7';ctx.font='12px system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,sans-serif';ctx.textAlign='center';ctx.textBaseline='top';for(let m=0;m<=60;m+=10){const x=padL+plotW*(m/60);ctx.fillText((60-m)==0?'ì§€ê¸ˆ':`-${60-m}m`,x,padT+plotH+6);}const vals=[];series.forEach(s=>s.data.forEach(v=>{if(Number.isFinite(v))vals.push(v);}));let vmin=Math.min(...(vals.length?vals:[0])),vmax=Math.max(...(vals.length?vals:[1]));if(vmax===vmin){vmax=vmin+1;}const pad=(vmax-vmin)*0.1;vmin-=pad;vmax+=pad;ctx.textAlign='right';ctx.textBaseline='middle';for(let g=0;g<=4;g++){const y=padT+plotH*g/4,val=vmax-(vmax-vmin)*g/4;ctx.fillText(val.toFixed((vmax-vmin)<10?1:0),padL-6,y);}function xAt(i){return padL+plotW*(i/59)}function yAt(v){return padT+((vmax-v)/ (vmax-vmin))*plotH}const cols=['#7aa0ff','#ff9a7a','#7affb0'];series.forEach((s,i)=>{ctx.beginPath();ctx.lineWidth=2;ctx.strokeStyle=s.color||cols[i%cols.length];let moved=false;const N=s.data.length;for(let i=0;i<60;i++){const idx=i-(60-N);const v=(idx>=0&&idx<N)?s.data[idx]:NaN;const x=xAt(i);if(Number.isFinite(v)){const y=yAt(v);if(!moved){ctx.moveTo(x,y);moved=true;}else ctx.lineTo(x,y);}else moved=false;}ctx.stroke();});}
function renderAllCharts(){if(!document.getElementById('graphSection').classList.contains('open'))return;const aht_t=histBuf.map(r=>r.aht_t),scd_t=histBuf.map(r=>r.scd_t),aht_h=histBuf.map(r=>r.aht_h),scd_h=histBuf.map(r=>r.scd_h),co2=histBuf.map(r=>r.co2);drawChart(document.getElementById('chTemp'),[{name:'AHT25 ì˜¨ë„',data:aht_t,color:'#7aa0ff'},{name:'SCD42 ì˜¨ë„',data:scd_t,color:'#ff9a7a'}],{legend:true});drawChart(document.getElementById('chHum'),[{name:'AHT25 ìŠµë„',data:aht_h,color:'#7aa0ff'},{name:'SCD42 ìŠµë„',data:scd_h,color:'#ff9a7a'}],{legend:true});drawChart(document.getElementById('chCO2'),[{name:'SCD42 COâ‚‚',data:co2,color:'#7aa0ff'}],{legend:true});}

/* ===== Wi-Fi ëª¨ë‹¬ ===== */
const bd=$('wifiBackdrop'); const openModal=()=>{ $('wifiHint').textContent=''; bd.style.display='grid'; }; const closeModal=()=>{ bd.style.display='none'; };
$('btnWifi').onclick=openModal; $('btnWifiCancel').onclick=closeModal;
$('btnWifiSave').onclick=async()=>{const ss=document.getElementById('inSsid').value.trim();const pw=document.getElementById('inPass').value;const hint=$('wifiHint');if(!ss||!pw){hint.textContent='SSID/ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.';return;}try{const r=await fetch(BASE+'/api/wifi',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({ssid:ss,pass:pw})});if(!r.ok)throw new Error('HTTP '+r.status);hint.textContent='ì „ì†¡ ì™„ë£Œ. ì¥ì¹˜ê°€ ì¬ì—°ê²° ì¤‘ì…ë‹ˆë‹¤â€¦';setTimeout(closeModal,900);}catch(e){hint.textContent='ì „ì†¡ ì‹¤íŒ¨: '+e.message;}};

/* ===== ë¶€íŠ¸ ===== */
(async()=>{
  // ìµœì‹ ê°’ í´ë§
  await refreshFast();
  setInterval(refreshFast, fastMs);
  // íˆìŠ¤í† ë¦¬/ì°¨íŠ¸
  await loadHistory60();
  try{const list=await fetchFirstJson(EP.history60); histBuf=list.map(normalizeRec).slice(-60);}catch(_){}
  setInterval(refreshLogOne, 60000);
  // ì‹œê³„
  setInterval(()=>{ tsTxt.textContent=fmtNow(); }, 1000);
})();
</script>
</body>
</html>
