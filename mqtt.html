<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ESP32 ì„¼ì„œ ëŒ€ì‹œë³´ë“œ (HiveMQ Public)</title>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<style>
/* (ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€) */
:root{--bg:#0b1020;--card:#131a2b;--txt:#e8eefc;--mut:#9fb2d7;--line:#22314f;--btn-bg:#1b2b4a;--btn-border:#2c3e63;--tile:#0f1526;--head:#12203a;--zebra:#10192c}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--txt);font:16px/1.45 system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,sans-serif}
.wrap{max-width:900px;margin:16px auto;padding:0 10px}
.card{background:var(--card);border-radius:16px;padding:14px}
h1{margin:0 0 6px;font-size:22px;font-weight:800;display:flex;justify-content:space-between;align-items:center}
.mut{color:var(--mut)} .mut.small{font-size:13px}
hr{border:0;border-top:1px solid var(--line);margin:12px 0}
.kpi-grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:6px;margin-top:2px}
.tile{background:var(--tile);border-radius:12px;padding:12px 10px;text-align:center;min-height:90px;display:flex;flex-direction:column;justify-content:center}
.kpi-label{font-size:17px;color:var(--mut)} .v{font-size:26px;font-weight:900;margin-top:2px} .u2{font-size:14px;color:var(--mut)}
.led{display:flex;align-items:center;gap:10px;margin-top:10px;flex-wrap:wrap}
.btn{border:0;color:#fff;padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:800;min-width:92px;font-size:14px}
.btn.on{background:#2d6bff}.btn.off{background:#32405e}.btn.active{background:#00cc66}.btn.dim{background:#1b2236}
.led-status{font-size:13px;color:var(--mut)}
.tablewrap{overflow:auto;background:var(--tile);border-radius:14px;padding:0;max-height:52vh;overflow-x:hidden}
table{border-collapse:collapse;width:100%;table-layout:fixed}
thead{display:none}            /* ë¦¬í”Œë˜ì‹œ ì‹œ í—¤ë” ê°ì¶¤ */
.show-head thead{display:table-header-group} /* ì—´ ë•Œë§Œ í‘œì‹œ */
thead th{position:sticky;top:0;background:var(--head);z-index:1;padding:7px 4px 6px;text-align:center;font-size:12.5px;font-weight:900}
tbody td{padding:8px 4px;border-bottom:1px solid var(--line);text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:14px;font-variant-numeric:tabular-nums}
tbody tr:nth-child(even){background:var(--zebra)}
col.time{width:14%} col.temp{width:15%} col.hum{width:15%} col.co2{width:20%} col.solar{width:22%} col.led{width:14%}
.charts{margin-top:12px;display:grid;grid-template-columns:1fr;gap:10px}
.chart{background:var(--tile);border-radius:12px;padding:8px}
.chart h3{margin:0 0 6px;font-size:14px;color:var(--mut)}
.canvas-wrap{position:relative;width:100%;height:160px}
.canvas-wrap canvas{position:absolute;inset:0;width:100%;height:100%}
.bottomRow{display:flex;justify-content:space-between;align-items:flex-end;gap:10px;color:var(--mut)}
#mini{white-space:nowrap;font-size:12px;line-height:1.2;margin:0;flex:1}
.timeText{font-size:12px;white-space:nowrap;margin:0 0 0 8px;text-align:right}
</style>
</head>
<body>
<div class="wrap"><div class="card">
  <h1>ESP32 ì„¼ì„œ ëŒ€ì‹œë³´ë“œ</h1>
  <p class="mut">ëœë¤ ì„¼ì„œ Â· LED ì œì–´</p>
  <p class="mut small" id="mqttState">ë¸Œë¡œì»¤ ì—°ê²° ì¤‘â€¦</p>

  <div class="kpi-grid">
    <div class="tile"><div class="kpi-label">ì˜¨ë„</div><div class="v" id="v_temp_val">--</div><div class="u2">Â°C</div></div>
    <div class="tile"><div class="kpi-label">ìŠµë„</div><div class="v" id="v_hum_val">--</div><div class="u2">%</div></div>
    <div class="tile"><div class="kpi-label">COâ‚‚</div><div class="v" id="v_co2_val">----</div><div class="u2">ppm</div></div>
    <div class="tile"><div class="kpi-label">ì¼ì‚¬ëŸ‰</div><div class="v" id="v_solar_val">--</div><div class="u2">W/mÂ²</div></div>
  </div>

  <div class="led">
    <button id="on"  class="btn on">LED ON</button>
    <button id="off" class="btn off">LED OFF</button>
    <div id="led" class="led-status">LED: -</div>
  </div>

  <hr>
  <div class="toggle-row">
    <button class="btn toggle" id="toggleTable">ğŸ“‹ í…Œì´ë¸” ë³´ê¸°</button>
    <button class="btn toggle" id="toggleGraph">ğŸ“Š ê·¸ë˜í”„ ë³´ê¸°</button>
  </div>

  <!-- ê¸°ë³¸: ë‹«í˜(í—¤ë” ê°ì¶¤) -->
  <div id="tableSection" class="collapsible">
    <div class="tablewrap">
      <table id="logtable">
        <colgroup><col class="time"><col class="temp"><col class="hum"><col class="co2"><col class="solar"><col class="led"></colgroup>
        <thead><tr><th>ì‹œê°„</th><th>ì˜¨ë„</th><th>ìŠµë„</th><th>COâ‚‚</th><th>ì¼ì‚¬ëŸ‰</th><th>LED</th></tr></thead>
        <tbody id="logtbl"></tbody>
      </table>
    </div>
  </div>

  <div id="graphSection" class="collapsible">
    <div class="charts">
      <div class="chart"><h3>ì˜¨ë„(Â°C)</h3><div class="canvas-wrap"><canvas id="chTemp"></canvas></div></div>
      <div class="chart"><h3>ìŠµë„(%)</h3><div class="canvas-wrap"><canvas id="chHum"></canvas></div></div>
      <div class="chart"><h3>COâ‚‚(ppm)</h3><div class="canvas-wrap"><canvas id="chCO2"></canvas></div></div>
      <div class="chart"><h3>ì¼ì‚¬ëŸ‰(W/mÂ²)</h3><div class="canvas-wrap"><canvas id="chSolar"></canvas></div></div>
    </div>
  </div>

  <hr>
  <div class="bottomRow">
    <p id="mini">RSSI: -- [dBm]</p>
    <div id="ts" class="timeText">â€”</div>
  </div>
</div></div>

<script>
// ===== ìœ í‹¸ =====
const $=s=>document.querySelector(s);
function fmtNow(){ const d=new Date(),p=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())}`; }

// ===== MQTT ì—°ê²° (HiveMQ Public WebSocket) =====
const brokerUrl = "wss://broker.hivemq.com:8884/mqtt";  // âœ… Public WS(TLS)
const mqttOpt = {
  clientId: "web-"+Math.random().toString(16).slice(2),
  clean: true,
  reconnectPeriod: 800,
  keepalive: 20,
  resubscribe: true
}; // âœ… user/pass ë¶ˆí•„ìš”
const client = mqtt.connect(brokerUrl, mqttOpt);

client.on('connect', ()=>{ $('#mqttState').textContent='MQTT ì—°ê²° OK'; client.subscribe('esp32/status'); });
client.on('reconnect', ()=> $('#mqttState').textContent='ë¸Œë¡œì»¤ ì¬ì—°ê²° ì¤‘â€¦');
client.on('offline',  ()=> $('#mqttState').textContent='ë¸Œë¡œì»¤ ì˜¤í”„ë¼ì¸');
client.on('error',    e => $('#mqttState').textContent='ì—ëŸ¬: '+e.message);

// ===== LED ì œì–´ â€” ì¦‰ì‹œ ë°˜ì˜ + QoS1 =====
const bon=$('#on'), boff=$('#off'), ledTxt=$('#led');
function setLedUi(on){
  bon.classList.toggle('active', on); bon.classList.toggle('dim', !on);
  boff.classList.toggle('active',!on); boff.classList.toggle('dim', on);
  ledTxt.textContent='LED: '+(on?'ON':'OFF');
}
function quickLed(cmd, expectOn){
  setLedUi(expectOn);                                 // ë‚™ê´€ì  ì—…ë°ì´íŠ¸
  client.publish('esp32/led', cmd, { qos: 1 });       // QoS1
}
bon.onclick  = ()=> quickLed('LED_ON',  true);
boff.onclick = ()=> quickLed('LED_OFF', false);

// ===== ìƒíƒœ ìˆ˜ì‹  =====
client.on('message', (topic,payload)=>{
  if(topic!=='esp32/status') return;
  const s = JSON.parse(new TextDecoder().decode(payload));
  renderStatus(s);
  localStorage.setItem('lastStatus', JSON.stringify(s));
  pushMinuteSample(s, new Date());
});

let histBuf = JSON.parse(localStorage.getItem('histBuf')||'[]');
let lastStatus = JSON.parse(localStorage.getItem('lastStatus')||'null');
const el = { tempVal:$('#v_temp_val'), humVal:$('#v_hum_val'), co2Val:$('#v_co2_val'), solarVal:$('#v_solar_val'), mini:$('#mini'), ts:$('#ts') };

function toBool(v){ if(typeof v==='boolean') return v; if(typeof v==='number') return v!==0;
  if(typeof v==='string'){ const t=v.trim().toLowerCase(); return t==='1'||t==='on'||t==='true'; } return !!v; }

function renderStatus(s){
  el.tempVal.textContent  = String(Math.round(Number(s.temp)));
  el.humVal.textContent   = String(Math.round(Number(s.hum)));
  el.co2Val.textContent   = String(Math.round(Number(s.co2)));
  el.solarVal.textContent = String(Math.round(Number(s.solar)));
  setLedUi(toBool(s.led));
  el.mini.textContent = `RSSI: ${('rssi' in s)?s.rssi:'--'} [dBm]`;
  el.ts.textContent   = fmtNow();
}

// ===== í…Œì´ë¸” í† ê¸€(ë¦¬í”Œë˜ì‹œ ê°ì¶¤, ì—´ ë•Œ í‘œì‹œ) =====
const secTable=$('#tableSection'), secGraph=$('#graphSection'), tbl=$('#logtable'), btnTable=$('#toggleTable');
btnTable.textContent='ğŸ“‹ í…Œì´ë¸” ë³´ê¸°';
btnTable.onclick=()=>{
  const opening=!secTable.classList.contains('open');
  secTable.classList.toggle('open');
  btnTable.textContent=opening?'ğŸ“‹ í…Œì´ë¸” ìˆ¨ê¸°ê¸°':'ğŸ“‹ í…Œì´ë¸” ë³´ê¸°';
  tbl.classList.toggle('show-head', opening);
  if(opening && histBuf.length){
    $('#logtbl').innerHTML='';
    for(let i=0;i<histBuf.length;i++){
      const r=histBuf[i];
      const ts=new Date(); ts.setMinutes(ts.getMinutes()-(histBuf.length-1-i));
      addRowTop({...r,led:false}, ts);
    }
  }
};

// ===== 1ë¶„ í‰ê· /í‘œì‹œ =====
function addRowTop(o,ts){
  const tb=$('#logtbl');
  const d=ts?new Date(ts):new Date();
  const hh=String(d.getHours()).padStart(2,'0'); const mm=String(d.getMinutes()).padStart(2,'0');
  const tr=document.createElement('tr');
  tr.innerHTML=`<td>${hh}:${mm}</td>
    <td>${Math.round(Number(o.temp))}</td>   <!-- í…Œì´ë¸” ì˜¨ë„ë§Œ ì •ìˆ˜ -->
    <td>${Math.round(Number(o.hum))}</td>
    <td>${Math.round(Number(o.co2))}</td>
    <td>${Math.round(Number(o.solar))}</td>
    <td>${toBool(o.led)?'ON':'OFF'}</td>`;
  if(tb.firstChild) tb.insertBefore(tr,tb.firstChild); else tb.appendChild(tr);
  while(tb.rows.length>60) tb.deleteRow(tb.rows.length-1);
}
let minuteKey=null, minuteSamples=[];
function pushMinuteSample(s, now){
  const key=now.getHours()*60+now.getMinutes();
  if(minuteKey!==null && key!==minuteKey && minuteSamples.length){
    const avg=k=>{ const v=minuteSamples.map(x=>+x[k]).filter(Number.isFinite); return v.length?v.reduce((a,b)=>a+b,0)/v.length:NaN; };
    const row={ temp:avg('temp'), hum:avg('hum'), co2:avg('co2'), solar:avg('solar'), led:minuteSamples.at(-1).led };
    addRowTop(row, new Date(now.getFullYear(),now.getMonth(),now.getDate(),Math.floor(minuteKey/60),minuteKey%60,0,0));
    histBuf.push({temp:row.temp, hum:row.hum, co2:row.co2, solar:row.solar});
    if(histBuf.length>60) histBuf.shift();
    localStorage.setItem('histBuf', JSON.stringify(histBuf));
    renderChartsAll();
  }
  minuteKey=key;
  minuteSamples.push({ temp:+s.temp, hum:+s.hum, co2:+s.co2, solar:+s.solar, led:toBool(s.led) });
}

// ===== ê·¸ë˜í”„(4ê°œ) =====
const dpr = ()=> window.devicePixelRatio||1;
function prepCanvas(c){ const r=c.getBoundingClientRect(); const w=Math.max(1,r.width),h=Math.max(1,r.height);
  c.width=Math.floor(w*dpr()); c.height=Math.floor(h*dpr()); const ctx=c.getContext('2d'); ctx.setTransform(dpr(),0,0,dpr(),0,0); return ctx; }
function drawSingleSeries(c, arr, color){
  const ctx=prepCanvas(c); const W=c.clientWidth,H=c.clientHeight;
  const padL=42,padR=10,padT=10,padB=22,plotW=W-padL-padR,plotH=H-padT-padB;
  ctx.clearRect(0,0,W,H);
  ctx.strokeStyle='#22314f'; ctx.beginPath();
  for(let g=0;g<=4;g++){const y=padT+plotH*g/4;ctx.moveTo(padL,y);ctx.lineTo(padL+plotW,y);}
  for(let m=0;m<=60;m+=10){const x=padL+plotW*(m/60);ctx.moveTo(x,padT);ctx.lineTo(x,padT+plotH);}
  ctx.stroke();
  const vals=arr.filter(v=>Number.isFinite(v));
  let vmin=Math.min(...(vals.length?vals:[0])), vmax=Math.max(...(vals.length?vals:[1])); if(vmax===vmin){vmax=vmin+1;}
  const pad=(vmax-vmin)*0.1; vmin-=pad; vmax+=pad;
  const xAt=i=>padL+plotW*(i/59), yAt=v=>padT+((vmax-v)/(vmax-vmin))*plotH;
  ctx.beginPath(); ctx.lineWidth=2; ctx.strokeStyle=color;
  let moved=false; const N=arr.length;
  for(let i=0;i<60;i++){
    const j=i-(60-N); const v=(j>=0&&j<N)?arr[j]:NaN; const x=xAt(i);
    if(Number.isFinite(v)){const y=yAt(v); if(!moved){ctx.moveTo(x,y); moved=true;} else ctx.lineTo(x,y);} else moved=false;
  }
  ctx.stroke();
}
function renderChartsAll(){
  if(!document.getElementById('graphSection').classList.contains('open')) return;
  const tempArr = histBuf.map(r=>r.temp??NaN);
  const humArr  = histBuf.map(r=>r.hum??NaN);
  const co2Arr  = histBuf.map(r=>r.co2??NaN);
  const solArr  = histBuf.map(r=>r.solar??NaN);
  drawSingleSeries(document.getElementById('chTemp'),  tempArr, '#7aa0ff');
  drawSingleSeries(document.getElementById('chHum'),   humArr,  '#ff9a7a');
  drawSingleSeries(document.getElementById('chCO2'),   co2Arr,  '#9ad67b');
  drawSingleSeries(document.getElementById('chSolar'), solArr,  '#d0a2ff');
}

/* ì´ˆê¸° í‘œì‹œ */
const last = JSON.parse(localStorage.getItem('lastStatus')||'null');
if(last){ renderStatus(last); }
</script>
</body>
</html>
