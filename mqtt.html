<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ESP32 센서 대시보드</title>
  <style>
    :root{
      --bg:#0b0f14; --card:#121821; --muted:#7c8aa5; --fg:#dbe7ff; --accent:#62a8ff; --ok:#46d37d; --warn:#ffcc66; --bad:#ff776e;
      --btn:#1b2431; --btnText:#dbe7ff; --ring:#23405f;
    }
    *{box-sizing:border-box}
    body{margin:0; background:var(--bg); color:var(--fg); font-family:system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", Apple SD Gothic Neo, Arial, sans-serif}
    header{display:flex; align-items:center; justify-content:space-between; padding:14px 16px; position:sticky; top:0; background:linear-gradient(180deg, rgba(11,15,20,.98), rgba(11,15,20,.85) 60%, rgba(11,15,20,0)); backdrop-filter:blur(8px); z-index:10}
    h1{margin:0; font-size:18px; letter-spacing:.2px}
    .actions{display:flex; gap:8px; align-items:center}
    .btn{background:var(--btn); color:var(--btnText); border:1px solid rgba(255,255,255,.06); padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:600}
    .btn:disabled{opacity:.6; cursor:not-allowed}
    .pill{padding:6px 10px; border-radius:999px; font-size:12px; border:1px solid rgba(255,255,255,.08); color:var(--muted)}
    main{max-width:980px; margin:24px auto; padding:0 14px; display:grid; gap:14px}
    .card{background:var(--card); border:1px solid rgba(255,255,255,.07); border-radius:14px; padding:14px}
    .grid{display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:14px}
    @media (max-width:760px){ .grid{grid-template-columns:1fr} }
    .title{display:flex; align-items:center; justify-content:space-between; margin-bottom:10px}
    .kv{display:grid; grid-template-columns:120px 1fr; gap:8px; row-gap:10px}
    .kv .k{color:var(--muted)}
    .val{font-weight:700}
    .led{display:flex; align-items:center; gap:10px}
    .led-dot{width:10px; height:10px; border-radius:50%; background:var(--bad); box-shadow:0 0 0 3px rgba(255,119,110,.12)}
    .led-dot.on{background:var(--ok); box-shadow:0 0 0 3px rgba(70,211,125,.12)}
    .statusline{margin-top:8px; color:var(--muted); font-size:12px}
    .log{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; color:#b8c7e6; background:#0d1320; border:1px solid rgba(255,255,255,.06); border-radius:10px; padding:10px; height:160px; overflow:auto; white-space:pre-wrap}
    .toast{position:fixed; bottom:18px; right:18px; background:#101723; color:var(--fg); padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.08); box-shadow:0 10px 30px rgba(0,0,0,.35); z-index:99; display:none}
    .modal-backdrop{position:fixed; inset:0; background:rgba(0,0,0,.5); backdrop-filter:blur(2px); display:none; place-items:center; z-index:50}
    .modal{width:min(92vw,520px); background:var(--card); border:1px solid rgba(255,255,255,.1); border-radius:16px; padding:16px}
    .row{display:flex; flex-direction:column; gap:6px; margin-bottom:10px}
    input[type="text"],input[type="password"]{width:100%; padding:10px 12px; background:#0e1520; color:var(--fg); border:1px solid rgba(255,255,255,.08); border-radius:10px; outline:none}
    input:focus{border-color:var(--accent); box-shadow:0 0 0 3px rgba(98,168,255,.18)}
    .modal .btns{display:flex; justify-content:flex-end; gap:8px}
    .muted{color:var(--muted)}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .bad{color:var(--bad)}
    .small{font-size:12px}
    .hidden{display:none !important}
  </style>
</head>
<body>
  <header>
    <h1>ESP32 센서 대시보드</h1>
    <div class="actions">
      <span id="connBadge" class="pill">연결 확인 중…</span>
      <button id="btnWifi" class="btn">Wi-Fi 설정</button>
      <button id="btnRefresh" class="btn">새로고침</button>
    </div>
  </header>

  <main>
    <section class="card">
      <div class="title">
        <strong>실시간 상태</strong>
        <div class="led"><div id="ledDot" class="led-dot"></div><button id="btnToggle" class="btn">LED 토글</button></div>
      </div>
      <div class="grid">
        <div class="card">
          <div class="kv">
            <div class="k">AHT 온도</div><div class="val" id="aht_t">--.- °C</div>
            <div class="k">AHT 습도</div><div class="val" id="aht_h">-- %</div>
            <div class="k">RSSI</div><div class="val" id="rssi">-- dBm</div>
          </div>
        </div>
        <div class="card">
          <div class="kv">
            <div class="k">SCD 온도</div><div class="val" id="scd_t">--.- °C</div>
            <div class="k">SCD 습도</div><div class="val" id="scd_h">-- %</div>
            <div class="k">CO₂</div><div class="val" id="co2">---- ppm</div>
          </div>
        </div>
      </div>
      <div class="statusline" id="statusLine">—</div>
    </section>

    <section class="card">
      <div class="title"><strong>최근 측정 로그</strong><span class="small muted">(최대 20개)</span></div>
      <div id="log" class="log"></div>
    </section>
  </main>

  <!-- Wi-Fi 설정 모달 -->
  <div id="wifiBackdrop" class="modal-backdrop">
    <div class="modal">
      <h3 style="margin:0 0 8px 0">Wi-Fi 설정</h3>
      <p class="muted small" style="margin-top:0">SSID와 비밀번호를 입력하면 장치가 잠시 후 해당 AP로 재연결합니다.</p>
      <div class="row">
        <label class="small muted">SSID</label>
        <input id="inSsid" type="text" placeholder="예: Backhome" />
      </div>
      <div class="row">
        <label class="small muted">비밀번호</label>
        <input id="inPass" type="password" placeholder="비밀번호" />
      </div>
      <div class="muted small" id="wifiHint"> </div>
      <div class="btns">
        <button id="btnWifiCancel" class="btn">취소</button>
        <button id="btnWifiSave" class="btn">저장 & 적용</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    // ======== 설정 ========
    const LS_BASE_KEY = 'esp32_base';
    const LS_WIFI_SSID = 'wifi_ssid';
    const LS_WIFI_PASS = 'wifi_pass';

    // 자동 탐색 후보: 1) 저장된 베이스 2) esp32.local 3) (옵션) 예전 고정 IP
    const CANDIDATES = (()=>{
      const saved = localStorage.getItem(LS_BASE_KEY);
      const list = [];
      if (saved) list.push(saved);
      list.push('http://esp32.local');
      // 필요한 경우 아래에 DHCP 환경에서 자주 쓰는 후보 추가 가능:
      // list.push('http://192.168.0.204','http://192.168.1.204','http://192.168.31.204');
      return list;
    })();

    const POLL_MS = 3000;
    let BASE = null;
    let pollTimer = null;

    // ======== DOM ========
    const el = (id)=>document.getElementById(id);
    const aht_t=el('aht_t'), aht_h=el('aht_h'), scd_t=el('scd_t'), scd_h=el('scd_h'), co2=el('co2'), rssi=el('rssi');
    const ledDot=el('ledDot'), btnToggle=el('btnToggle');
    const connBadge=el('connBadge'), statusLine=el('statusLine');
    const logEl=el('log');
    const btnRefresh=el('btnRefresh');
    const toastEl=el('toast');

    const wifiBackdrop=el('wifiBackdrop'), btnWifi=el('btnWifi'), btnWifiCancel=el('btnWifiCancel'), btnWifiSave=el('btnWifiSave');
    const inSsid=el('inSsid'), inPass=el('inPass'), wifiHint=el('wifiHint');

    // ======== 유틸 ========
    const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
    function fmt(val, unit){ return `${val} ${unit}`; }
    function showToast(msg, ms=2000){ toastEl.textContent = msg; toastEl.style.display='block'; setTimeout(()=>toastEl.style.display='none', ms); }
    function setConnBadge(ok){
      connBadge.textContent = ok ? '연결됨' : '연결 끊김';
      connBadge.style.color = ok ? 'var(--ok)' : 'var(--bad)';
    }
    function addLog(line){
      const now = new Date();
      const hh = now.toTimeString().slice(0,8);
      const lines = (line+'').split('\n');
      lines.forEach(l=>{ logEl.textContent += `[${hh}] ${l}\n`; });
      // 250라인 제한
      const parts = logEl.textContent.split('\n');
      if (parts.length > 250) logEl.textContent = parts.slice(parts.length-250).join('\n');
      logEl.scrollTop = logEl.scrollHeight;
    }

    // ======== 장치 베이스 자동 탐색 ========
    async function tryBase(url){
      try{
        const ctrl = new AbortController();
        const t = setTimeout(()=>ctrl.abort(), 1200);
        const r = await fetch(url + '/api/status', {signal:ctrl.signal});
        clearTimeout(t);
        if (!r.ok) throw new Error('HTTP '+r.status);
        return true;
      }catch(e){ return false; }
    }

    async function discoverBase(){
      setConnBadge(false);
      connBadge.textContent = '연결 확인 중…';
      for (const cand of CANDIDATES){
        if (await tryBase(cand)){
          BASE = cand;
          localStorage.setItem(LS_BASE_KEY, BASE);
          setConnBadge(true);
          addLog(`기기 연결됨: ${BASE}`);
          statusLine.textContent = `엔드포인트: ${BASE}`;
          return true;
        }
      }
      addLog('기기 탐색 실패. 잠시 후 재시도합니다.');
      statusLine.textContent = '장치 탐색 실패';
      return false;
    }

    // ======== 표시에 반영 ========
    function applyStatus(js){
      // 펌웨어가 캐시로 깜빡임을 줄여주지만, 프론트에서도 이전 값을 유지
      const tA = Number(js.aht_t)||0, hA = Number(js.aht_h)||0;
      const tS = Number(js.scd_t)||0, hS = Number(js.scd_h)||0;
      const co  = Number(js.co2)||0;
      const led = !!js.led;
      const rs  = Number(js.rssi)||0;

      aht_t.textContent = `${tA.toFixed(1)} °C`;
      aht_h.textContent = `${hA.toFixed(0)} %`;
      scd_t.textContent = `${tS.toFixed(1)} °C`;
      scd_h.textContent = `${hS.toFixed(0)} %`;
      co2.textContent   = co ? `${co} ppm` : '---- ppm';
      rssi.textContent  = `${rs} dBm`;

      ledDot.classList.toggle('on', led);
      setConnBadge(true);
    }

    async function fetchStatus(){
      if (!BASE) return;
      try{
        const r = await fetch(BASE + '/api/status');
        if (!r.ok) throw new Error('HTTP '+r.status);
        const js = await r.json();
        applyStatus(js);
      }catch(e){
        setConnBadge(false);
        // 실패 시 재탐색 시도
        await sleep(500);
        if (await discoverBase()){
          await sleep(400);
        }
      }
    }

    // ======== LED 토글 ========
    async function toggleLed(){
      if (!BASE) return;
      try{
        const r = await fetch(BASE + '/api/led?state=toggle', {method:'POST'}); // 펌웨어는 on/off만 처리 → 아래 대체
        if (!r.ok) throw new Error('HTTP '+r.status);
        const js = await r.json();
        applyStatus(js);
        addLog(`LED: ${js.led ? 'ON' : 'OFF'}`);
      }catch(_){
        // fallback: 상태 먼저 조회 후 반대값으로 설정
        try{
          const rs = await fetch(BASE + '/api/status');
          const st = await rs.json();
          const next = st.led ? 'off' : 'on';
          const r2 = await fetch(BASE + '/api/led?state='+next, {method:'POST'});
          const js2 = await r2.json();
          applyStatus(js2);
          addLog(`LED: ${js2.led ? 'ON' : 'OFF'}`);
        }catch(e2){
          addLog('LED 제어 실패: ' + e2.message);
          setConnBadge(false);
        }
      }
    }

    // ======== 폴링 ========
    function startPolling(){
      if (pollTimer) clearInterval(pollTimer);
      pollTimer = setInterval(fetchStatus, POLL_MS);
      fetchStatus();
    }

    // ======== Wi-Fi 모달 ========
    function openWifiModal(){
      const s = localStorage.getItem(LS_WIFI_SSID)||'';
      const p = localStorage.getItem(LS_WIFI_PASS)||'';
      inSsid.value = s; inPass.value = p;
      wifiHint.textContent = '';
      wifiBackdrop.style.display = 'grid';
    }
    function closeWifiModal(){ wifiBackdrop.style.display = 'none'; }

    btnWifi.addEventListener('click', openWifiModal);
    btnWifiCancel.addEventListener('click', closeWifiModal);
    btnWifiSave.addEventListener('click', async ()=>{
      const ssid = inSsid.value.trim();
      const pass = inPass.value;
      if (!ssid || !pass) { wifiHint.textContent = 'SSID/비밀번호를 입력하세요.'; return; }
      localStorage.setItem(LS_WIFI_SSID, ssid);
      localStorage.setItem(LS_WIFI_PASS, pass);

      if (!BASE){
        wifiHint.textContent = '장치 연결을 먼저 확인 중입니다…';
        await discoverBase();
      }
      if (!BASE){
        wifiHint.textContent = '장치가 보이지 않습니다. 같은 네트워크인지 확인하세요.';
        return;
      }

      try{
        // 펌웨어는 200 OK 먼저 응답 → 잠시 후 재접속
        const r = await fetch(BASE + '/api/wifi', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ssid, pass})
        });
        if (!r.ok) throw new Error('HTTP '+r.status);
        wifiHint.textContent = '전송 완료. 장치가 재연결 중입니다…';
        showToast('Wi-Fi 저장됨. 재연결 대기…', 2200);
        setTimeout(()=>{ closeWifiModal(); }, 900);

        // 재탐색 루프: 3초 간격으로 최대 7회
        for (let i=0;i<7;i++){
          await sleep(3000);
          addLog('재탐색 시도 중…');
          if (await discoverBase()){
            addLog('재탐색 성공. 데이터 갱신 시작.');
            fetchStatus();
            break;
          }
        }
      }catch(e){
        wifiHint.textContent = '전송 실패: ' + e.message;
        showToast('전송 실패: ' + e.message, 2300);
      }
    });

    // ======== 초기화 ========
    (async function init(){
      btnToggle.addEventListener('click', toggleLed);
      btnRefresh.addEventListener('click', fetchStatus);

      // 최초 실행: 저장된 SSID/PASS 없으면 자동 오픈
      const ss = localStorage.getItem(LS_WIFI_SSID);
      const pw = localStorage.getItem(LS_WIFI_PASS);
      if (!ss || !pw) {
        setTimeout(openWifiModal, 400);
      }

      // 장치 자동 탐색 → 폴링 시작
      await discoverBase();
      startPolling();
    })();
  </script>
</body>
</html>
