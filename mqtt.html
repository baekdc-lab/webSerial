<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ESP32 센서 대시보드 (빠른 LED 반응)</title>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<style>
:root{--bg:#0b1020;--card:#131a2b;--txt:#e8eefc;--mut:#9fb2d7;--line:#22314f;--tile:#0f1526;--head:#12203a;--zebra:#10192c}
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--txt);font:16px/1.45 system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,sans-serif}
.wrap{max-width:900px;margin:16px auto;padding:0 10px} .card{background:var(--card);border-radius:16px;padding:14px}
h1{margin:0 0 6px;font-size:22px;font-weight:800;display:flex;justify-content:space-between;align-items:center}
.mut{color:var(--mut)} .mut.small{font-size:13px} hr{border:0;border-top:1px solid var(--line);margin:12px 0}

/* KPI */
.kpi-grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:6px;margin-top:2px}
.tile{background:var(--tile);border-radius:12px;padding:12px 10px;text-align:center;min-height:90px;display:flex;flex-direction:column;justify-content:center}
.kpi-label{font-size:17px;color:var(--mut)} .v{font-size:26px;font-weight:900;margin-top:2px} .u2{font-size:14px;color:var(--mut)}

/* LED */
.led{display:flex;align-items:center;gap:10px;margin-top:10px;flex-wrap:wrap}
.btn{border:0;color:#fff;padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:800;min-width:92px;font-size:14px}
.btn.on{background:#2d6bff}.btn.off{background:#32405e}.btn.active{background:#00cc66}.btn.dim{background:#1b2236}
.led-status{font-size:13px;color:var(--mut)}

/* Table */
.tablewrap{overflow:auto;background:var(--tile);border-radius:14px;padding:0;max-height:52vh;overflow-x:hidden}
table{border-collapse:collapse;width:100%;table-layout:fixed}
thead{display:table-header-group}
thead th{position:sticky;top:0;background:var(--head);z-index:1;padding:7px 4px 6px;text-align:center;font-size:12.5px;font-weight:900}
tbody td{padding:8px 4px;border-bottom:1px solid var(--line);text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:14px;font-variant-numeric:tabular-nums}
tbody tr:nth-child(even){background:var(--zebra)}
col.time{width:14%} col.temp{width:15%} col.hum{width:15%} col.co2{width:20%} col.solar{width:22%} col.led{width:14%}

/* Charts */
.charts{margin-top:12px;display:grid;grid-template-columns:1fr;gap:10px}
.chart{background:var(--tile);border-radius:12px;padding:8px}
.chart h3{margin:0 0 6px;font-size:14px;color:var(--mut)}
.canvas-wrap{position:relative;width:100%;height:160px}
.canvas-wrap canvas{position:absolute;inset:0;width:100%;height:100%}

/* Footer */
.bottomRow{display:flex;justify-content:space-between;align-items:flex-end;gap:10px;color:var(--mut)}
#mini{white-space:nowrap;font-size:12px;line-height:1.2;margin:0;flex:1}
.timeText{font-size:12px;white-space:nowrap;margin:0 0 0 8px;text-align:right}
</style>
</head>
<body>
<div class="wrap"><div class="card">
  <h1>ESP32 센서 대시보드</h1>
  <p class="mut small" id="mqttState">브로커 연결 중…</p>

  <div class="kpi-grid">
    <div class="tile"><div class="kpi-label">온도</div><div class="v" id="v_temp_val">--</div><div class="u2">°C</div></div>
    <div class="tile"><div class="kpi-label">습도</div><div class="v" id="v_hum_val">--</div><div class="u2">%</div></div>
    <div class="tile"><div class="kpi-label">CO₂</div><div class="v" id="v_co2_val">----</div><div class="u2">ppm</div></div>
    <div class="tile"><div class="kpi-label">일사량</div><div class="v" id="v_solar_val">--</div><div class="u2">W/m²</div></div>
  </div>

  <div class="led">
    <button id="on"  class="btn on">LED ON</button>
    <button id="off" class="btn off">LED OFF</button>
    <div id="led" class="led-status">LED: -</div>
  </div>

  <hr>
  <div class="tablewrap">
    <table id="logtable">
      <colgroup><col class="time"><col class="temp"><col class="hum"><col class="co2"><col class="solar"><col class="led"></colgroup>
      <thead><tr><th>시간</th><th>온도</th><th>습도</th><th>CO₂</th><th>일사량</th><th>LED</th></tr></thead>
      <tbody id="logtbl"></tbody>
    </table>
  </div>

  <div class="charts">
    <div class="chart"><h3>온도(°C)</h3><div class="canvas-wrap"><canvas id="chTemp"></canvas></div></div>
    <div class="chart"><h3>습도(%)</h3><div class="canvas-wrap"><canvas id="chHum"></canvas></div></div>
    <div class="chart"><h3>CO₂(ppm)</h3><div class="canvas-wrap"><canvas id="chCO2"></canvas></div></div>
    <div class="chart"><h3>일사량(W/m²)</h3><div class="canvas-wrap"><canvas id="chSolar"></canvas></div></div>
  </div>

  <hr>
  <div class="bottomRow">
    <p id="mini">RSSI: -- [dBm]</p>
    <div id="ts" class="timeText">—</div>
  </div>
</div></div>

<script>
// ===== 유틸 =====
const $=s=>document.querySelector(s);
function nowStr(){const d=new Date(),p=n=>String(n).padStart(2,'0');return`${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())}`}

// ===== MQTT 연결 (빠른 재연결/keepalive) =====
const brokerUrl="wss://6c56aefe0ddb4d57977c735f5070abe8.s1.eu.hivemq.cloud:8884/mqtt";
const mqttOpt={
  username:"mqtt_ESP32",
  password:"gomqtt_ESP32",
  clientId:"web-"+Math.random().toString(16).slice(2),
  clean:true,
  reconnectPeriod:800, // 빠른 재연결
  keepalive:20,        // ping 간격 단축
  resubscribe:true
};
const client=mqtt.connect(brokerUrl,mqttOpt);

client.on('connect',()=>{$('#mqttState').textContent='MQTT 연결 OK';client.subscribe('esp32/status');});
client.on('reconnect',()=>$('#mqttState').textContent='브로커 재연결 중…');
client.on('offline', ()=>$('#mqttState').textContent='브로커 오프라인');
client.on('error',   e =>$('#mqttState').textContent='에러: '+e.message);

// ===== 즉시 반응형 LED + QoS1 =====
const bon=$('#on'), boff=$('#off'), ledTxt=$('#led');
function setLedUi(on){
  bon.classList.toggle('active',on); bon.classList.toggle('dim',!on);
  boff.classList.toggle('active',!on); boff.classList.toggle('dim',on);
  ledTxt.textContent='LED: '+(on?'ON':'OFF');
}
function quickLed(cmd, expectOn){
  setLedUi(expectOn); // 클릭 즉시 반영
  client.publish('esp32/led', cmd, { qos:1, retain:false });
}
bon.onclick = ()=> quickLed('LED_ON',  true);
boff.onclick= ()=> quickLed('LED_OFF', false);

// ===== 상태 수신 =====
client.on('message',(topic,payload)=>{
  if(topic!=='esp32/status') return;
  const s = JSON.parse(new TextDecoder().decode(payload));
  renderStatus(s); addRowTop(s,new Date()); pushGraph(s);
});

function renderStatus(s){
  $('#v_temp_val').textContent = Math.round(Number(s.temp));  // KPI도 정수 원하시면 여기 유지
  $('#v_hum_val').textContent  = Math.round(Number(s.hum));
  $('#v_co2_val').textContent  = Math.round(Number(s.co2));
  $('#v_solar_val').textContent= Math.round(Number(s.solar));
  setLedUi(!!s.led); // 서버 상태로 UI 확정
  $('#mini').textContent = `RSSI: ${('rssi' in s)?s.rssi:'--'} [dBm]`;
  $('#ts').textContent   = nowStr();
}

// ===== 테이블 (온도만 정수) =====
function addRowTop(o,ts){
  const tb=$('#logtbl'); const d=new Date(ts);
  const hh=String(d.getHours()).padStart(2,'0'), mm=String(d.getMinutes()).padStart(2,'0');
  const tr=document.createElement('tr');
  tr.innerHTML=`<td>${hh}:${mm}</td>
    <td>${Math.round(Number(o.temp))}</td>  <!-- 온도 정수화 -->
    <td>${Math.round(Number(o.hum))}</td>
    <td>${Math.round(Number(o.co2))}</td>
    <td>${Math.round(Number(o.solar))}</td>
    <td>${o.led?'ON':'OFF'}</td>`;
  if(tb.firstChild) tb.insertBefore(tr,tb.firstChild); else tb.appendChild(tr);
  while(tb.rows.length>60) tb.deleteRow(tb.rows.length-1);
}

// ===== 그래프(4개) =====
const buf={t:[],h:[],c:[],s:[]};
function pushGraph(s){
  buf.t.push(+s.temp); buf.h.push(+s.hum); buf.c.push(+s.co2); buf.s.push(+s.solar);
  ['t','h','c','s'].forEach(k=>{ if(buf[k].length>60) buf[k].shift(); });
  drawCharts();
}
function drawCharts(){
  drawLine('chTemp', buf.t, '#7aa0ff');
  drawLine('chHum',  buf.h, '#ff9a7a');
  drawLine('chCO2',  buf.c, '#9ad67b');
  drawLine('chSolar',buf.s, '#d0a2ff');
}
function drawLine(id, arr, color){
  const c=document.getElementById(id); const ctx=c.getContext('2d');
  const dpr=window.devicePixelRatio||1, W=c.clientWidth, H=c.clientHeight;
  c.width=W*dpr; c.height=H*dpr; ctx.setTransform(dpr,0,0,dpr,0,0);
  ctx.clearRect(0,0,W,H);
  if(!arr.length){return;}
  const min=Math.min(...arr), max=Math.max(...arr); const span=(max-min)||1;
  ctx.beginPath(); ctx.strokeStyle=color; ctx.lineWidth=2;
  for(let i=0;i<arr.length;i++){
    const x=(i/(60-1))*W; const y=H-(arr[i]-min)/span*H;
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  }
  ctx.stroke();
}
</script>
</body>
</html>
