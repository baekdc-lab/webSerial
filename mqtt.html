<!doctype html>
<html lang="ko"><head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ESP32 ì„¼ì„œ ëŒ€ì‹œë³´ë“œ</title>
<style>
:root{ --bg:#0b1020;--card:#131a2b;--txt:#e8eefc;--mut:#9fb2d7;--line:#22314f;--btn-bg:#1b2b4a;--btn-border:#2c3e63; }
:root.light{ --bg:#f5f7fa;--card:#ffffff;--txt:#0b1020;--mut:#5a6b8a;--line:#ccd4e0;--btn-bg:#e4e8ef;--btn-border:#b0bacb; }
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--txt);font:16px/1.5 system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,sans-serif;transition:background .3s,color .3s}
.wrap{max-width:900px;margin:20px auto;padding:0 12px}
.card{background:var(--card);border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25);transition:background .3s}
h1{margin:0 0 8px;font-size:26px;font-weight:800;display:flex;justify-content:space-between;align-items:center}
.mut{color:var(--mut);margin:0 0 12px}
.status{margin-top:8px;color:var(--mut);font-size:14px;white-space:pre-line}
hr{border:0;border-top:1px solid var(--line);margin:14px 0;transition:border-color .3s}

/* Theme toggle */
.theme-toggle{cursor:pointer;font-size:22px;user-select:none;transition:transform .2s}
.theme-toggle:hover{transform:scale(1.15)}

/* Wi-Fi/í† ê¸€ ë²„íŠ¼ */
.actions{display:flex;gap:8px;align-items:center}
.btn{border:0;color:#fff;padding:12px 14px;border-radius:12px;cursor:pointer;font-weight:800;min-width:98px;font-size:15px;transition:all .2s}
.btn.toggle{background:var(--btn-bg);border:1px solid var(--btn-border);color:var(--txt);min-width:120px}
.btn.wifi{background:var(--btn-bg);border:1px solid var(--btn-border);color:var(--txt);min-width:96px}

/* KPI Tiles */
.grid{display:grid;grid-template-columns:repeat(5,minmax(0,1fr));gap:12px;margin-top:6px}
.tile{background:#0f1526;border-radius:12px;padding:12px;text-align:center;min-height:76px;transition:background .3s}
:root.light .tile{background:#eef1f7}
.v{font-size:22px;font-weight:800;margin-top:4px}

/* LED ë²„íŠ¼ */
.led{display:flex;align-items:center;gap:12px;margin-top:12px;flex-wrap:wrap}
.btn.on{background:#2d6bff;} .btn.off{background:#32405e;} .btn.active{background:#00cc66;} .btn.dim{background:#1b2236;}

/* í† ê¸€ í•œ ì¤„ */
.toggle-row{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 12px}

/* í…Œì´ë¸” */
.tablewrap{overflow:auto;background:#0f1526;border-radius:14px;padding:0 6px 6px 0;max-height:50vh}
:root.light .tablewrap{background:#eef1f7}
table{border-collapse:collapse;width:auto;min-width:100%}
thead th{position:sticky;top:0;z-index:2;background:#12203a;white-space:nowrap}
:root.light thead th{background:#d6deec}
th,td{padding:6px 8px;border-bottom:1px solid var(--line);text-align:right;font-size:13px}
th:first-child,td:first-child{text-align:center;padding-left:0;padding-right:4px}

/* ì°¨íŠ¸ */
.charts{margin-top:14px;display:grid;grid-template-columns:1fr;gap:12px}
.chart{background:#0f1526;border-radius:12px;padding:10px}
:root.light .chart{background:#eef1f7}
.chart h3{margin:0 0 8px;font-size:15px;color:var(--mut);font-weight:700}
.canvas-wrap{position:relative;width:100%;height:200px}
.canvas-wrap canvas{position:absolute;left:0;top:0;width:100%;height:100%}

/* ìƒíƒœ/í•˜ë‹¨ */
#raw{white-space:pre-line;font-size:12px;color:var(--mut)}
#foot{display:flex;align-items:center;justify-content:space-between;gap:8px;font-size:12px;color:var(--mut);margin-top:4px}
#foot > span{white-space:nowrap}

/* Wi-Fi ëª¨ë‹¬ */
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:999}
.modal{background:var(--card);border-radius:14px;padding:16px;min-width:280px;max-width:90vw;box-shadow:0 10px 30px rgba(0,0,0,.35)}
.modal h3{margin:0 0 10px}
.modal .row{display:flex;flex-direction:column;gap:6px;margin:8px 0}
.modal input{background:transparent;border:1px solid var(--btn-border);color:var(--txt);padding:10px;border-radius:10px;outline:none}
.modal .acts{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
.modal .acts .btn{min-width:auto;padding:10px 12px}
/* â˜… ëª¨ë‹¬ í‘œì‹œ ë²„ê·¸ ìˆ˜ì • */
.modal-backdrop.show{display:flex}

@media (max-width:480px){
  h1{font-size:22px}
  .btn{min-width:96px;font-size:15px;padding:12px}
  .canvas-wrap{height:180px}
}
</style></head>
<body>
<div class="wrap"><div class="card">
  <h1>
    <span>ESP32 ì„¼ì„œ ëŒ€ì‹œë³´ë“œ</span>
    <span class="actions">
      <button id="btnWifi" class="btn wifi">Wi-Fi</button>
      <span class="theme-toggle" id="themeToggle">ğŸŒ™</span>
    </span>
  </h1>
  <p class="mut">AHT25(ì˜¨/ìŠµ) + SCD42(ì˜¨/ìŠµ/COâ‚‚) Â· LEDì œì–´</p>

  <div id="banner" class="status">â€”</div>
  <div class="grid">
    <div class="tile"><div>AHT25 ì˜¨ë„</div><div id="aht_t" class="v">--.- Â°C</div></div>
    <div class="tile"><div>AHT25 ìŠµë„</div><div id="aht_h" class="v">-- %</div></div>
    <div class="tile"><div>SCD42 ì˜¨ë„</div><div id="scd_t" class="v">--.- Â°C</div></div>
    <div class="tile"><div>SCD42 ìŠµë„</div><div id="scd_h" class="v">-- %</div></div>
    <div class="tile"><div>COâ‚‚ ê³µê¸°</div><div id="scd_c" class="v">---- ppm</div></div>
  </div>

  <div class="led">
    <button id="on"  class="btn on">LED ON</button>
    <button id="off" class="btn off">LED OFF</button>
    <div id="led" class="status">LED: -</div>
  </div>

  <hr>
  <div class="toggle-row">
    <button class="btn toggle" id="toggleTable">ğŸ“‹ í…Œì´ë¸” ë³´ê¸°</button>
    <button class="btn toggle" id="toggleGraph">ğŸ“Š ê·¸ë˜í”„ ë³´ê¸°</button>
  </div>

  <div id="tableSection" class="collapsible">
    <div class="tablewrap"><table>
      <thead><tr>
        <th>ì‹œê°„</th><th>AHT&nbsp;Â°C</th><th>AHT&nbsp;%</th>
        <th>SCD&nbsp;Â°C</th><th>SCD&nbsp;%</th><th>COâ‚‚</th><th>LED</th>
      </tr></thead>
      <tbody id="logtbl"></tbody>
    </table></div>
  </div>

  <div id="graphSection" class="collapsible">
    <div class="charts">
      <div class="chart"><h3>ì˜¨ë„ (Â°C) â€” ìµœê·¼ 60ë¶„</h3><div class="canvas-wrap"><canvas id="chTemp"></canvas></div></div>
      <div class="chart"><h3>ìŠµë„ (%) â€” ìµœê·¼ 60ë¶„</h3><div class="canvas-wrap"><canvas id="chHum"></canvas></div></div>
      <div class="chart"><h3>COâ‚‚ (ppm) â€” ìµœê·¼ 60ë¶„</h3><div class="canvas-wrap"><canvas id="chCO2"></canvas></div></div>
    </div>
  </div>

  <hr>
  <div class="status" id="raw">â€”</div>
  <div id="foot"><span id="rssi">RSSI: -- [dBm]</span><span id="ts">â€”</span></div>
</div></div>

<!-- Wi-Fi ëª¨ë‹¬ -->
<div id="wifiModal" class="modal-backdrop">
  <div class="modal">
    <h3>Wi-Fi ì—°ê²°</h3>
    <div class="row">
      <label>SSID</label>
      <input id="inSsid" placeholder="ë„¤íŠ¸ì›Œí¬ ì´ë¦„">
    </div>
    <div class="row">
      <label>ë¹„ë°€ë²ˆí˜¸</label>
      <input id="inPw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸(í•„ìš” ì‹œ)">
    </div>
    <div id="wifiHint" class="mut">í˜„ì¬ ìƒíƒœ í™•ì¸ ì¤‘â€¦</div>
    <div class="acts">
      <button class="btn dim" id="wifiCancel">ì·¨ì†Œ</button>
      <button class="btn on"  id="wifiConnect">ì—°ê²°</button>
    </div>
  </div>
</div>

<script>
const $=s=>document.querySelector(s);

/* Theme */
const themeToggle=$('#themeToggle');
function applyTheme(t){document.documentElement.classList.toggle('light', t==='light');themeToggle.textContent=(t==='light')?'â˜€ï¸':'ğŸŒ™';}
applyTheme(localStorage.getItem('theme')||'dark');
themeToggle.onclick=()=>{const t=document.documentElement.classList.contains('light')?'dark':'light';applyTheme(t);localStorage.setItem('theme',t);};

/* Toggle */
function setToggle(btn,sec,show,hide){const sync=()=>btn.textContent=sec.classList.contains('open')?hide:show;btn.onclick=()=>{sec.classList.toggle('open');sync();};sync();}
setToggle($('#toggleTable'),$('#tableSection'),'ğŸ“‹ í…Œì´ë¸” ë³´ê¸°','ğŸ“‹ í…Œì´ë¸” ìˆ¨ê¸°ê¸°');
setToggle($('#toggleGraph'),$('#graphSection'),'ğŸ“Š ê·¸ë˜í”„ ë³´ê¸°','ğŸ“Š ê·¸ë˜í”„ ìˆ¨ê¸°ê¸°');

/* API (ë™ì¼ ì¶œì²˜) */
const EP={ status:'/api/status', ledOn:'/api/led/on', ledOff:'/api/led/off', wifiStatus:'/api/wifi/status', wifiConnect:'/api/wifi/connect' };
async function getJSON(u,opt={}){ const r=await fetch(u,{...opt,cache:'no-store'}); if(!r.ok) throw new Error(r.status); return r.json(); }

/* ìƒíƒœ/LED */
function syncButtons(led){const on=$('#on'),off=$('#off');on.classList.remove('active','dim');off.classList.remove('active','dim');if(led){on.classList.add('active');off.classList.add('dim');}else{off.classList.add('active');on.classList.add('dim');}}
function tick(){ const d=new Date(),p=n=>String(n).padStart(2,'0'); $('#ts').textContent=`${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())}`; }
async function refreshFast(){
  try{
    const s=await getJSON(EP.status);
    const led=(s.led=='1'||s.led===1||s.led==='on'||s.led===true);
    $('#aht_t').textContent = s.aht_t!=null ? Number(s.aht_t).toFixed(1)+' Â°C' : '--.- Â°C';
    $('#aht_h').textContent = s.aht_h!=null ? Math.round(Number(s.aht_h))+' %' : '-- %';
    $('#scd_t').textContent = s.scd_t!=null ? Number(s.scd_t).toFixed(1)+' Â°C' : '--.- Â°C';
    $('#scd_h').textContent = s.scd_h!=null ? Math.round(Number(s.scd_h))+' %' : '-- %';
    $('#scd_c').textContent = s.co2!=null ? s.co2+' ppm' : '---- ppm';
    $('#led').textContent   = 'LED: ' + (led?'ON':'OFF'); syncButtons(led);
    $('#rssi').textContent  = 'RSSI: ' + (s.rssi!=null? s.rssi+' [dBm]' : '-- [dBm]');
    $('#banner').textContent= 'AHT25/SCD42 ì—°ê²° OK';
  }catch{ $('#banner').textContent='í†µì‹  ì˜¤ë¥˜'; }
  tick();
}
$('#on').onclick  = async()=>{ try{ await fetch(EP.ledOn); }catch{} refreshFast(); };
$('#off').onclick = async()=>{ try{ await fetch(EP.ledOff);}catch{} refreshFast(); };
setInterval(refreshFast,3000); setInterval(tick,1000); refreshFast();

/* Wi-Fi ëª¨ë‹¬ */
const mBackdrop=$('#wifiModal'); const wifiHint=$('#wifiHint');
$('#btnWifi').onclick=()=>{ mBackdrop.classList.add('show'); getJSON(EP.wifiStatus).then(s=>{ wifiHint.textContent=s.connected?`ì—°ê²°ë¨: ${s.ssid} (${s.ip})`:'ë¯¸ì—°ê²°'; }).catch(()=>wifiHint.textContent='ìƒíƒœ ì¡°íšŒ ì‹¤íŒ¨'); };
$('#wifiCancel').onclick=()=>mBackdrop.classList.remove('show');
$('#wifiConnect').onclick=async()=>{
  const ssid=$('#inSsid').value.trim(), password=$('#inPw').value;
  if(!ssid){ wifiHint.textContent='SSIDë¥¼ ì…ë ¥í•˜ì„¸ìš”.'; return; }
  wifiHint.textContent='ì—°ê²° ì‹œë„ ì¤‘â€¦';
  try{
    const r=await fetch(EP.wifiConnect,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({ssid,password})});
    const j=await r.json();
    if(j.ok){
      wifiHint.textContent=`ì—°ê²°ë¨: ${j.ssid} (${j.ip})`;
      refreshFast();
      setTimeout(()=>mBackdrop.classList.remove('show'),800);
    }else{
      const st=j.status_text||j.status, rs=j.reason_text||j.reason||'';
      wifiHint.textContent=`ì—°ê²° ì‹¤íŒ¨: ${st}${rs?` / ${rs}`:''}. SSID/ë¹„ë°€ë²ˆí˜¸ ë˜ëŠ” 2.4GHz ì—¬ë¶€ë¥¼ í™•ì¸í•˜ì„¸ìš”.`;
    }
  }catch(e){
    wifiHint.textContent='ì—°ê²° ì˜¤ë¥˜: ì¥ì¹˜ì™€ í†µì‹  ë¶ˆê°€';
  }
};
</script>
</body></html>
