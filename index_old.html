<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>WebSerial Console â€” Dark</title>

<style>
/* ---------------------------------------------------------
   GLOBAL
--------------------------------------------------------- */
:root{
    --bg:#0b0f14;
    --panel:#111827;
    --muted:#2a2f39;
    --text:#e5e7eb;
    --dim:#9aa4b2;
    --accent:#3b82f6;
    --success:#10b981;
    --danger:#ef4444;
    --radius:14px;
    --mono:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
}

body{
    margin:0;
    background:var(--bg);
    color:var(--text);
    font:15px/1.45 system-ui,sans-serif;
}

.container{
    width:100%;
    padding:16px;
    box-sizing:border-box;
}

/* ---------------------------------------------------------
   HEADER
--------------------------------------------------------- */
header{
    display:flex;
    align-items:center;
    gap:10px;
    margin-bottom:10px;
}
header h1{
    margin:0;
    font-size:20px;
    font-weight:700;
}

/* ---------------------------------------------------------
   MAIN LAYOUT (flex push)
--------------------------------------------------------- */
.main-wrap{
    display:flex;
    width:100%;
    gap:16px;
    transition:all .25s ease;
}

.console-area{
    flex:1 1 auto;
    min-width:200px;
}

.panel{
    background:var(--panel);
    border:1px solid var(--muted);
    border-radius:var(--radius);
    padding:14px;
    box-shadow:0 10px 25px rgba(0,0,0,.35);
    box-sizing:border-box;
}

.row{
    display:flex;
    gap:10px;
    align-items:center;
    flex-wrap:wrap;
}
.grow{flex:1 1 auto;}

button{
    padding:8px 12px;
    border-radius:10px;
    border:1px solid var(--muted);
    background:#0f172a;
    color:var(--text);
    cursor:pointer;
}
button:hover{border-color:#3b4150;}

.btn-primary{
    background:linear-gradient(180deg,#2563eb,#1e40af);
    border-color:#1e3a8a;
}
.btn-success{
    background:linear-gradient(180deg,#059669,#047857);
}
.btn-danger{
    background:linear-gradient(180deg,#b91c1d,#7f1d1d);
}

select,input[type=text],textarea{
    background:#0e1622;
    color:var(--text);
    border:1px solid var(--muted);
    border-radius:10px;
    padding:8px 10px;
    font-size:14px;
}

#log{
    width:100%;
    height:420px;
    resize:vertical;
    box-sizing:border-box;
    font-family:var(--mono);
    font-size:15px;
}

/* ---------------------------------------------------------
   CONNECT STATUS BOX
--------------------------------------------------------- */
#statusBox{
    text-align:right;
    font-size:14px;
    margin-bottom:8px;
    padding:6px 10px;
    border-radius:8px;
    border:1px solid var(--muted);
    background:#0f172a;
    font-weight:600;
    display:flex;
    justify-content:flex-end;
    align-items:center;
    gap:8px;
}

.status-dot{
    width:10px;
    height:10px;
    border-radius:50%;
    background:#64748b;
}
.status-dot.on { background:#10b981; }
.status-dot.off { background:#ef4444; }

/* ---------------------------------------------------------
   PRESET PANEL (PC: push layout)
--------------------------------------------------------- */
#presetPanel{
    width:0px;
    overflow:hidden;
    transition: width .28s ease, height .28s ease;
}

#presetPanel.open{
    width:400px;
}

#presetPanel .inner{
    width:400px;
}

/* GROUP HEADER */
.group-header{
    font-weight:800;
    color:#3b82f6;
    font-size:15px;
    margin:16px 0 6px 0;
}

/* CHIP */
.chip{
    display:inline-flex;
    align-items:center;
    padding:6px 10px;
    background:#0f172a;
    border:1px solid var(--muted);
    border-radius:999px;
    margin:6px 6px 0 0;
    cursor:pointer;
    font-size:13px;
}
.chip:hover{border-color:#3b4150;}
.chip .del{margin-left:8px;cursor:pointer;opacity:0.65;}

.small{font-size:13px;color:var(--dim);}

/* ---------------------------------------------------------
   ğŸ”¥ ë°˜ì‘í˜•: 768px ì´í•˜ì—ì„œëŠ” í”„ë¦¬ì…‹ íŒ¨ë„ì„ ì•„ë˜ë¡œ ì´ë™
--------------------------------------------------------- */
@media (max-width: 768px){

    .main-wrap{
        flex-direction:column;
    }

    /* í”„ë¦¬ì…‹ íŒ¨ë„ì´ ì „ì²´ ë„ˆë¹„ ì°¨ì§€ */
    #presetPanel{
        width:100%!important;
        height:0px;
    }

    #presetPanel.open{
        height:auto;
        width:100%!important;
    }

    #presetPanel .inner{
        width:100%!important;
    }

}
</style>
</head>
<body>

<div class="container">

<header>
    <h1>WebSerial Console</h1>
    <button id="btnPanelToggle" class="btn-primary">í”„ë¦¬ì…‹</button>
</header>

<div class="main-wrap">

    <!-- LEFT AREA -->
    <div class="console-area">

        <!-- CONNECT STATUS -->
        <div id="statusBox">
            <span class="status-dot"></span>
            <span id="statusText">ëŒ€ê¸°ì¤‘</span>
        </div>

        <section class="panel">

            <div class="row" style="margin-bottom:10px;">
                <label>Baud</label>
                <select id="baud">
                    <option>115200</option><option>57600</option>
                    <option>38400</option><option>19200</option>
                    <option>9600</option>
                </select>

                <label>ëë¬¸ì</label>
                <select id="ending">
                    <option value="">ì—†ìŒ</option>
                    <option value="\n">LF</option>
                    <option value="\r\n" selected>CRLF</option>
                    <option value="\r">CR</option>
                </select>

                <span class="grow"></span>

                <button id="btnConnect" class="btn-primary">ì—°ê²°</button>
                <button id="btnDisconnect" disabled>í•´ì œ</button>
            </div>

            <textarea id="log" readonly></textarea>

            <div class="row" style="margin-top:10px;">
                <button id="btnClear">ì§€ìš°ê¸°</button>
                <button id="btnSave">ì €ì¥</button>
                <span class="grow"></span>
                <label class="small">
                    <input type="checkbox" id="chkAutoscroll" checked> ìë™ ìŠ¤í¬ë¡¤
                </label>
            </div>

            <div class="row" style="margin-top:10px;">
                <input id="tx" class="grow" type="text" placeholder="ë©”ì‹œì§€ ì…ë ¥â€¦" />
                <button id="btnSend" class="btn-success" disabled>ì „ì†¡</button>
            </div>

        </section>
    </div>

    <!-- RIGHT PRESET PANEL -->
    <aside id="presetPanel">
        <div class="inner panel">
            <h3 style="margin-top:0; font-size:16px;">í”„ë¦¬ì…‹</h3>

            <div class="row" style="margin-bottom:10px;">
                <input id="presetText" class="grow" type="text" placeholder="ì˜ˆ: STATUS" />
                <button id="btnAdd" class="btn-primary">ì¶”ê°€</button>
            </div>

            <div class="row" style="margin-bottom:10px;">
                <button id="btnExport">ë‚´ë³´ë‚´ê¸°</button>
                <button id="btnImport">ê°€ì ¸ì˜¤ê¸°</button>
                <input type="file" id="importFile" accept="application/json" style="display:none">
                <span class="grow"></span>
                <button id="btnClearPresets" class="btn-danger">ì „ì²´ ì‚­ì œ</button>
            </div>

            <div id="chips"></div>
        </div>
    </aside>

</div>
</div>

<script>
/* =========================================================
   PRESET STORAGE
========================================================= */
const LS_KEY = "ws_presets_v6";
const load = () => JSON.parse(localStorage.getItem(LS_KEY) || "[]");
const save = arr => localStorage.setItem(LS_KEY, JSON.stringify(arr));

/* =========================================================
   PANEL TOGGLE (ìƒ‰ ë°˜ì „)
========================================================= */
const btnPanelToggle = document.getElementById("btnPanelToggle");
const presetPanel = document.getElementById("presetPanel");

btnPanelToggle.onclick = () => {

    const open = presetPanel.classList.toggle("open");

    if(open){
        btnPanelToggle.textContent = "í”„ë¦¬ì…‹ ë‹«ê¸°";
        btnPanelToggle.classList.remove("btn-primary");
    } else {
        btnPanelToggle.textContent = "í”„ë¦¬ì…‹";
        btnPanelToggle.classList.add("btn-primary");
    }
};

/* =========================================================
   RENDER PRESETS (GROUP ì§€ì›)
========================================================= */
function renderChips(){
    const box = document.getElementById("chips");
    box.innerHTML = "";

    const presets = load();

    if (!presets.length){
        box.innerHTML = `<div class="small">í”„ë¦¬ì…‹ì„ ì¶”ê°€í•˜ì„¸ìš”.</div>`;
        return;
    }

    presets.forEach((text, idx)=>{
        
        if(text.startsWith("[GROUP] ")){
            const title = text.replace("[GROUP] ","");

            const header = document.createElement("div");
            header.className = "group-header";
            header.textContent = title;

            box.appendChild(header);
            return;
        }

        const chip = document.createElement("div");
        chip.className = "chip";
        chip.innerHTML = text + ` <span class="del">âœ•</span>`;
        chip.onclick = ()=> sendText(text);

        chip.querySelector(".del").onclick = (e)=>{
            e.stopPropagation();
            const arr = load();
            arr.splice(idx,1);
            save(arr);
            renderChips();
        };

        box.appendChild(chip);
    });
}

document.getElementById("btnAdd").onclick = ()=>{
    const v=document.getElementById("presetText").value.trim();
    if(!v) return;
    const arr=load();
    arr.unshift(v);
    save(arr);
    renderChips();
    document.getElementById("presetText").value="";
};

document.getElementById("btnExport").onclick = ()=>{
    const blob=new Blob([JSON.stringify(load(),null,2)],{type:"application/json"});
    const a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download="presets.json";
    a.click();
};

document.getElementById("btnImport").onclick =
 ()=> document.getElementById("importFile").click();

document.getElementById("importFile").onchange = (e)=>{
    const f=e.target.files[0];
    if(!f) return;

    const r=new FileReader();
    r.onload=()=>{
        try{
            const json=JSON.parse(r.result);
            if(!Array.isArray(json)) throw "í˜•ì‹ ì˜¤ë¥˜";
            save(json);
            renderChips();
        }catch(err){ alert("ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: "+err); }
    };
    r.readAsText(f);
};

document.getElementById("btnClearPresets").onclick = ()=>{
    if(confirm("ëª¨ë‘ ì‚­ì œí•©ë‹ˆê¹Œ?")){
        save([]);
        renderChips();
    }
};

/* =========================================================
   Windows-style BEEP SOUNDS
========================================================= */
function beep(freq = 880, duration = 120){
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();

    osc.frequency.value = freq;
    osc.type = "sine";

    osc.connect(gain);
    gain.connect(ctx.destination);

    osc.start();
    gain.gain.setValueAtTime(0.25, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + duration/1000);
    osc.stop(ctx.currentTime + duration/1000);
}

function playConnectSound(){
    beep(784,120);
    setTimeout(()=>beep(1046,160),120);
}

function playDisconnectSound(){
    beep(587,120);
    setTimeout(()=>beep(392,160),120);
}

/* =========================================================
   WebSerial CORE
========================================================= */
let port, reader, writer;

const statusDot = document.querySelector("#statusBox .status-dot");
const statusText = document.getElementById("statusText");

function updateStatus(mode){
    if(mode==="connect"){
        statusDot.classList.add("on");
        statusDot.classList.remove("off");
        statusText.textContent = "ì—°ê²°ë¨";
    } else if(mode==="disconnect"){
        statusDot.classList.remove("on");
        statusDot.classList.add("off");
        statusText.textContent = "í•´ì œë¨";
    } else {
        statusDot.classList.remove("on");
        statusDot.classList.remove("off");
        statusText.textContent = "ëŒ€ê¸°ì¤‘";
    }
}

async function connect(){
    try{
        port = await navigator.serial.requestPort();
        await port.open({ baudRate:Number(document.getElementById("baud").value) });

        const dec = new TextDecoderStream();
        port.readable.pipeTo(dec.writable);
        reader = dec.readable.getReader();

        const enc = new TextEncoderStream();
        enc.readable.pipeTo(port.writable);
        writer = enc.writable.getWriter();

        document.getElementById("btnConnect").disabled = true;
        document.getElementById("btnDisconnect").disabled = false;
        document.getElementById("btnSend").disabled = false;

        updateStatus("connect");
        playConnectSound();
        readLoop();

    }catch(err){
        alert("ì—°ê²° ì‹¤íŒ¨\n"+err);
    }
}

async function disconnect(){
    try{
        if(reader){ await reader.cancel(); reader=null; }
        if(writer){ await writer.close(); writer=null; }
        if(port){ await port.close(); port=null; }
    }catch{}

    document.getElementById("btnConnect").disabled = false;
    document.getElementById("btnDisconnect").disabled = true;
    document.getElementById("btnSend").disabled = true;

    updateStatus("disconnect");
    playDisconnectSound();
}

async function readLoop(){
    while(port && reader){
        const {value,done} = await reader.read();
        if(done) break;
        if(value) appendLog(value);
    }
}

function appendLog(t){
    const log=document.getElementById("log");
    log.value+=t;
    if(document.getElementById("chkAutoscroll").checked)
        log.scrollTop=log.scrollHeight;
}

function sendText(txt){
    if(!writer) return alert("ì—°ê²° í•„ìš”");
    writer.write(txt + document.getElementById("ending").value);
}

/* BUTTON HOOK */
document.getElementById("btnConnect").onclick = connect;
document.getElementById("btnDisconnect").onclick = disconnect;
document.getElementById("btnSend").onclick =
 ()=> sendText(document.getElementById("tx").value);

document.getElementById("btnClear").onclick =
 ()=> document.getElementById("log").value="";

document.getElementById("btnSave").onclick = ()=>{
    const blob=new Blob([document.getElementById("log").value],{type:"text/plain"});
    const a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download="log.txt";
    a.click();
};

/* Enter to Send */
document.getElementById("tx").onkeydown = (e)=>{
    if(e.key==="Enter" && !e.shiftKey){
        e.preventDefault();
        sendText(document.getElementById("tx").value);
    }
};

/* INIT */
renderChips();
updateStatus("idle");

</script>
</body>
</html>
