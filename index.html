<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>Web Serial Mini Console â€” Dark</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      /* dark theme (default) */
      --bg:#0b0f14; --panel:#111827; --muted:#2a2f39; --text:#e5e7eb; --dim:#9aa4b2;
      --accent:#3b82f6; --success:#10b981; --danger:#ef4444; --radius:14px; --mono:"ui-monospace",SFMono-Regular,Menlo,Consolas,monospace;
    }
    html,body{height:100%}
    html{color-scheme:dark}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif}
    .container{max-width:1200px;margin:0 auto;padding:18px}
    header{display:flex;align-items:center;gap:10px;margin-bottom:10px}
    header h1{font-size:20px;margin:0;font-weight:700}
    header small{margin-left:auto;color:var(--dim)}

    .grid{display:grid;grid-template-columns: minmax(520px,1fr) 460px;gap:16px}
    @media (max-width: 980px){.grid{grid-template-columns:1fr}}

    .panel{background:var(--panel);border:1px solid var(--muted);border-radius:var(--radius);box-shadow:0 10px 25px rgba(0,0,0,.35);padding:14px}
    .panel h2{font-size:13px;color:var(--dim);margin:0 0 8px}

    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .grow{flex:1 1 auto}
    label{color:var(--dim)}
    select,input[type=text],textarea{background:#0e1622;color:var(--text);border:1px solid var(--muted);border-radius:10px;padding:8px 10px;outline:none;font-size:14px}
    select:focus,input:focus,textarea:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(59,130,246,.2)}

    button{padding:8px 12px;border-radius:10px;border:1px solid var(--muted);background:#0f172a;color:var(--text);cursor:pointer;font-size:14px}
    button:hover{border-color:#3b4150}
    button:disabled{opacity:.55;cursor:not-allowed}
    .btn-primary{background:linear-gradient(180deg,#2563eb,#1e40af);border-color:#1e3a8a}
    .btn-danger{background:linear-gradient(180deg,#b91c1c,#7f1d1d);border-color:#7f1d1d}
    .btn-success{background:linear-gradient(180deg,#059669,#047857);border-color:#065f46}
    .btn-ghost{background:transparent}

    .status-dot{display:inline-block;width:8px;height:8px;border-radius:50%;background:#64748b;margin-right:6px}
    .status-dot.on{background:#22c55e}
    .status{font-family:var(--mono);color:var(--dim)}

    #log{width:100%;height:420px;resize:vertical;box-sizing:border-box;font-family:var(--mono);font-size:16px}
    .small{font-size:12px;color:var(--dim)}

    .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--muted);border-radius:999px;background:#0f172a;margin:6px 6px 0 0;cursor:pointer;font-size:14px}
    .chip:hover{border-color:#3b4150}
    .chip .x{opacity:.7}

    .hint{display:block;margin-top:10px}
    .kbd{padding:.5px 6px;border:1px solid var(--muted);border-bottom-width:2px;border-radius:6px;background:#0f172a;color:var(--dim);font-family:var(--mono)}
  
  :root.light{
      --bg:#f6f7f9;
      --panel:#ffffff;
      --muted:#e2e8f0;
      --text:#0f172a;
      --dim:#475569;
      --accent:#2563eb;
      --success:#059669;
      --danger:#dc2626;
  }
  .light select, .light input[type=text], .light textarea{
      background:#f8fafc;
      color:#0f172a;
      border:1px solid #cbd5e1;
  }
  .light #log{
      background:#e2e8f0;
      color:#1e293b;
  }
  .light .chip{
      background:#f1f5f9;
      color:#0f172a;
      border-color:#cbd5e1;
  }



.light #themeToggle{
    color:#0f172a !important;
    background:#f1f5f9 !important;
    border:1px solid #cbd5e1 !important;
}


.light #themeToggle, .light button#themeToggle{
    color:#0f172a !important;
    background:#f1f5f9 !important;
    border:1px solid #cbd5e1 !important;
}


/* Apple-style light mode button fixes */
.light button,
.light .btn-primary,
.light .btn-danger,
.light .btn-success {
    background: #f1f5f9 !important;
    color: #0f172a !important;
    border: 1px solid #cbd5e1 !important;
    box-shadow: none !important;
}

.light button:hover,
.light .btn-primary:hover,
.light .btn-danger:hover,
.light .btn-success:hover {
    background: #e2e8f0 !important;
}

.light #themeToggle {
    background: #f1f5f9 !important;
    color: #0f172a !important;
    border: 1px solid #cbd5e1 !important;
}

</style>
</head>
<body>




  <div class="container">
    <header>
      <h1>Web Serial Mini Console</h1>
      <button id="themeToggle" class="btn-ghost" style="margin-left:auto;font-size:18px;">â˜€ï¸</button>
    </header>

    <div class="grid">
      <section class="panel">
        <div class="row" style="margin-bottom:8px">
          <label for="baud">Baud</label>
          <select id="baud">
            <option selected>115200</option><option>57600</option><option>38400</option>
            <option>19200</option><option>9600</option><option>4800</option><option>2400</option><option>1200</option>
          </select>
          <label for="ending">ì¶œë ¥(ì „ì†¡)</label>
          <select id="ending">
            <option value="">ì—†ìŒ</option>
            <option value="\n">LF (\\n)</option>
            <option value="\r\n" selected>CRLF (\\r\\n)</option>
            <option value="\r">CR (\\r)</option>
          </select>
          <label for="encoding">ì¸ì½”ë”©</label>
          <select id="encoding"><option selected>UTF-8</option></select>
          <span class="grow"></span>
          <button id="btnConnect" class="btn-primary">í¬íŠ¸ ì—°ê²°</button>
          <button id="btnDisconnect" disabled>í•´ì œ</button>
        </div>

        <div class="row small" style="margin-bottom:8px">
          <span class="status"><span id="dot" class="status-dot"></span><span id="status">ëŒ€ê¸° ì¤‘</span></span>
          <label><input type="checkbox" id="chkAutoscroll" checked> ìë™ ìŠ¤í¬ë¡¤</label>
        </div>

        <textarea id="log" readonly></textarea>

        <div class="row" style="margin-top:8px">
          <button id="btnClear" class="btn-ghost">ë¡œê·¸ ì§€ìš°ê¸°</button>
          <button id="btnSave" class="btn-ghost">ë¡œê·¸ ì €ì¥</button>
          <span class="grow"></span>
          <label class="small"><input type="checkbox" id="chkEnterSend" checked> Enterë¡œ ì „ì†¡ <span class="dim">(Shift+Enter ì¤„ë°”ê¿ˆ)</span></label>
        </div>

        <div class="row" style="margin-top:8px">
          <input id="tx" class="grow" type="text" placeholder="ë³´ë‚¼ ë©”ì‹œì§€..." />
          <button id="btnSend" class="btn-success">ì „ì†¡</button>
        </div>

        <span class="small hint">ì—°ê²°ì°½ì´ ì•ˆ ëœ¨ë©´: HTTPS/localhostì—ì„œ ì—´ê³ , ì´ í˜ì´ì§€ë¥¼ <button id="btnOpenTop" class="btn-ghost">ìƒˆ íƒ­(ìµœìƒìœ„)ìœ¼ë¡œ ì—´ê¸°</button></span>
      </section>

      <aside class="panel">
        <h2>í”„ë¦¬ì…‹ ì¶”ê°€</h2>
        <div class="row" style="margin-bottom:8px">
          <input id="presetText" class="grow" type="text" placeholder="ì˜ˆ: STATUS, LED ON, NODE" />
          <button id="btnAdd" class="btn-primary">ì¶”ê°€</button>
        </div>
        <div class="row" style="margin-bottom:8px">
          <button id="btnExport" class="btn-ghost">ë‚´ë³´ë‚´ê¸°</button>
          <input id="importFile" type="file" accept="application/json" style="display:none">
          <button id="btnImport" class="btn-ghost">ê°€ì ¸ì˜¤ê¸°</button>
          <span class="grow"></span>
          <button id="btnClearPresets" class="btn-danger">ì „ì²´ ì‚­ì œ</button>
        </div>
        <div id="chips"></div>
      </aside>
    </div>
  </div>

  <script>
    if (!("serial" in navigator)) {
      alert("ì´ ë¸Œë¼ìš°ì €ëŠ” Web Serial APIë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. Chrome/Edge ìµœì‹ ë²„ì „ì„ ì‚¬ìš©í•˜ì„¸ìš”.");
    }

    let port=null, reader=null, writer=null, readableClosed=null, writableClosed=null;
    const el=(id)=>document.getElementById(id);
    const setDot=(on)=> el('dot').classList.toggle('on', !!on);
    const status=(msg)=> el('status').textContent=msg;

    function setConnectedUI(connected){
      el('btnConnect').disabled=connected;
      el('btnDisconnect').disabled=!connected;
      el('baud').disabled=connected;
      el('ending').disabled=connected;
      el('encoding').disabled=connected;
      el('btnSend').disabled=!connected;
      el('tx').disabled=!connected;
      setDot(connected);
    }

    function appendLog(text){
      const log=el('log');
      log.value += text;
      if(el('chkAutoscroll').checked){ log.scrollTop = log.scrollHeight; }
    }

    function resolveEnding(){
      return el('ending').value.replace('\\n','\n').replace('\\r\\n','\r\n').replace('\\r','\r');
    }

    async function connect(){
      try{
        port=await navigator.serial.requestPort();
        const baudRate=Number(el('baud').value)||9600;
        await port.open({baudRate});
        const textDecoder=new TextDecoderStream();
        readableClosed=port.readable.pipeTo(textDecoder.writable).catch(()=>{});
        reader=textDecoder.readable.getReader();
        const textEncoder=new TextEncoderStream();
        writableClosed=textEncoder.readable.pipeTo(port.writable).catch(()=>{});
        writer=textEncoder.writable.getWriter();
        setConnectedUI(true); status(`ì—°ê²°ë¨ @ ${baudRate} baud`);
        usbConnect();
        playConnectSound();
        readLoop();
      }catch(err){
        console.error(err); status('ì—°ê²° ì‹¤íŒ¨'); alert('ì—°ê²° ì‹¤íŒ¨:\n'+err); await disconnect(true);
      }
    }

    async function disconnect(silent=false){
      try{
        if(reader){ try{await reader.cancel()}catch{} try{await readableClosed}catch{} try{reader.releaseLock()}catch{} reader=null }
        if(writer){ try{await writer.close()}catch{} try{await writableClosed}catch{} try{writer.releaseLock()}catch{} writer=null }
        if(port){ try{await port.close()}catch{} port=null }
      }finally{ setConnectedUI(false); if(!silent) status('í•´ì œë¨');
        usbDisconnect();
        playDisconnectSound(); }
    }

    async function readLoop(){
      if(!reader) return;
      try{
        while(true){
          const {value, done}=await reader.read();
          if(done) break;
          if(value) appendLog(value);
        }
      }catch(err){ console.warn('readLoop error:', err) }
      finally{ if(port && !port.readable){ await disconnect(true); status('ì—°ê²° ëŠê¹€') } }
    }

    async function sendText(text){
      if(!port||!writer){ alert('í¬íŠ¸ê°€ ì—°ê²°ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.'); return }
      try{
        await writer.write(text+resolveEnding());
      }catch(err){ console.error(err); alert('ì „ì†¡ ì‹¤íŒ¨:\n'+err) }
    }

    function saveLog(){
      const blob=new Blob([el('log').value],{type:'text/plain;charset=utf-8'});
      const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='webserial-log.txt';a.click();URL.revokeObjectURL(a.href);
    }

    const LS_KEY='ws_presets_chips_v1';
    const load=()=>{try{return JSON.parse(localStorage.getItem(LS_KEY))||[]}catch{return[]}};
    const save=(arr)=>localStorage.setItem(LS_KEY,JSON.stringify(arr));

    
    function renderChips(){
      const host=el('chips'); host.innerHTML='';
      const items=load();
      if(!items.length){
        const s=document.createElement('div'); s.className='small';
        s.textContent='í´ë¦­í•˜ë©´ ì¦‰ì‹œ ì „ì†¡ë©ë‹ˆë‹¤.'; host.appendChild(s); return;
      }
      items.forEach((item,i)=>{
        if(item.startsWith("[GROUP] ")){
          const h=document.createElement('div');
          h.style.marginTop="12px"; h.style.fontWeight="bold"; h.style.fontSize="15px";
          h.textContent=item.replace("[GROUP] ","");
          host.appendChild(h);
        } else {
          const row=document.createElement('div');
          row.style.display="flex"; row.style.alignItems="center"; row.style.marginLeft="12px";
          const chip=document.createElement('button'); chip.type='button';
          chip.className='chip'; chip.textContent=item;
          chip.addEventListener('click',()=>sendText(item));
          const del=document.createElement('span'); del.textContent='âœ•';
          del.style.cursor='pointer'; del.style.marginLeft='6px';
          del.addEventListener('click',e=>{e.stopPropagation(); delChip(i);});
          chip.appendChild(del); row.appendChild(chip); host.appendChild(row);
        }
      });
    }

      
    function addChip(text){const arr=load(); arr.unshift(String(text)); save(arr); renderChips()}
    function delChip(idx){const arr=load(); arr.splice(idx,1); save(arr); renderChips()}

    el('btnConnect').addEventListener('click', ()=>{ unlockAudio(); connect(); });
    el('btnDisconnect').addEventListener('click',()=>disconnect());
    el('btnSend').addEventListener('click',()=>sendText(el('tx').value));
    el('btnClear').addEventListener('click',()=>{el('log').value='' });
    el('btnSave').addEventListener('click',saveLog);
    el('btnOpenTop').addEventListener('click',()=>{window.open(location.href,'_blank','noopener')});

    el('tx').addEventListener('keydown',(ev)=>{if(ev.key==='Enter'&&!ev.shiftKey&&el('chkEnterSend').checked){ev.preventDefault();sendText(el('tx').value)}});

    el('btnAdd').addEventListener('click',()=>{const v=el('presetText').value.trim();if(!v)return;addChip(v);el('presetText').value='';el('presetText').focus()});
    el('btnExport').addEventListener('click',()=>{
      const blob=new Blob([JSON.stringify(load(),null,2)],{type:'application/json'});
      const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='webserial-presets.json';a.click();URL.revokeObjectURL(a.href);
    });

el('btnImport').addEventListener('click', ()=> el('importFile').click());

    
    el('importFile').addEventListener('change',(e)=>{
      const f=e.target.files&&e.target.files[0];
      if(!f)return;
      const r=new FileReader();
      r.onload=()=>{
        try{
          const json = JSON.parse(r.result);
          let finalList = [];
          if(Array.isArray(json)){
            finalList = json.map(String);
          } else if(typeof json === "object" && json !== null){
            for(const group in json){
              const arr = json[group];
              if(Array.isArray(arr)){
                finalList.push("[GROUP] "+group);
                finalList.push(...arr.map(String));
              }
            }
          } else throw new Error("í˜•ì‹ ì˜¤ë¥˜");
          save(finalList); renderChips();
        }catch(err){ alert("ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: "+err.message); }
      };
      r.readAsText(f);
      e.target.value='';
    });

    el('btnClearPresets').addEventListener('click',()=>{if(!confirm('ëª¨ë“  í”„ë¦¬ì…‹ì„ ì‚­ì œí• ê¹Œìš”?'))return;save([]);renderChips()});

    setConnectedUI(false); renderChips(); enableDragDrop();
    window.addEventListener('beforeunload',async()=>{await disconnect(true)});
  
    // Theme toggle logic
    const body = document.body;
    const toggleBtn = document.getElementById('themeToggle');

    function applyTheme(){
        const isLight = localStorage.getItem('ws_theme') === 'light';
        document.documentElement.classList.toggle('light', isLight);
        toggleBtn.textContent = isLight ? 'ğŸŒ™' : 'â˜€ï¸';
    }

    toggleBtn.addEventListener('click', ()=>{
        const isLight = localStorage.getItem('ws_theme') === 'light';
        localStorage.setItem('ws_theme', isLight ? 'dark' : 'light');
        applyTheme();
    });

    applyTheme();


function playConnectSound(){
  const a=document.getElementById("sndConnect");
  if(a) a.play().catch(()=>{});
}
function playDisconnectSound(){
  const a=document.getElementById("sndDisconnect");
  if(a) a.play().catch(()=>{});
}


// ---- AUDIO UNLOCK (required for Chrome autoplay policy) ----
function unlockAudio(){
    const a = document.getElementById("sndConnect");
    const b = document.getElementById("sndDisconnect");

    if(a){
        a.play().then(()=>{
            a.pause();
            a.currentTime = 0;
        }).catch(()=>{});
    }
    if(b){
        b.play().then(()=>{
            b.pause();
            b.currentTime = 0;
        }).catch(()=>{});
    }
}


// ---- WebAudio Beep (always works, not blocked by autoplay) ----
function beep(freq = 880, duration = 120){
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();

    osc.type = "sine";
    osc.frequency.value = freq;

    osc.connect(gain);
    gain.connect(ctx.destination);

    osc.start();
    gain.gain.setValueAtTime(0.2, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + duration / 1000);
    osc.stop(ctx.currentTime + duration / 1000);
}


// Windows USB-style tones
function usbConnect(){
    beep(784,120);
    setTimeout(()=>beep(1046,160),150);
}
function usbDisconnect(){
    beep(587,120);
    setTimeout(()=>beep(392,160),150);
}


// --- Drag & Drop for presets ---
function enableDragDrop(){
    const chips = document.querySelectorAll('#chips .chip');
    chips.forEach((chip, index)=>{
        chip.draggable = true;
        chip.dataset.index = index;

        chip.addEventListener('dragstart', e=>{
            e.dataTransfer.setData('text/plain', index);
        });
    });

    const host = document.getElementById('chips');
    host.addEventListener('dragover', e=> e.preventDefault());

    host.addEventListener('drop', e=>{
        e.preventDefault();
        const from = Number(e.dataTransfer.getData('text/plain'));
        const toChip = e.target.closest('.chip');
        if(!toChip) return;
        const to = Number(toChip.dataset.index);

        const arr = load();
        const moved = arr.splice(from,1)[0];
        arr.splice(to,0,moved);
        save(arr);
        renderChips(); enableDragDrop();
        enableDragDrop();
    });
}

</script>
</body>
</html>
