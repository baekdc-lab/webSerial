<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset='UTF-8'>
  <meta name='viewport' content='width=device-width, initial-scale=1.0'>
  <title>WebSerial Console (CMD Click Send)</title>
  <script src='https://cdn.tailwindcss.com'></script>
</head>

<body class='bg-gray-900 text-gray-100 p-5'>
<div id='mainLayout' class='flex flex-row gap-6 w-full'>

  <!-- LEFT PANEL -->
  <div class='w-[65%] bg-gray-800 p-5 rounded-xl shadow-lg border border-gray-700'>
    <h2 class='text-3xl font-bold mb-4'>WebSerial Console</h2>

    <div class='flex justify-between mb-4 items-end'>
      <div class='flex gap-4 items-end'>
        <div>
          <label class='text-lg'>Baud</label>
          <select id='baud' class='bg-gray-700 border border-gray-600 rounded px-2 py-1 w-24'>
            <option>9600</option>
            <option selected>115200</option>
          </select>
        </div>

        <div>
          <label class='text-lg'>ëë¬¸ì</label>
          <select id='ending' class='bg-gray-700 border border-gray-600 rounded px-2 py-1 w-28'>
            <option value='\n'>LF (\n)</option>
            <option value='\r'>CR (\r)</option>
            <option value='\r\n' selected>CRLF (\r\n)</option>
          </select>
        </div>
      </div>

      <div class='flex gap-2'>
        <button id='connectBtn' class='bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded'>í¬íŠ¸ ì—°ê²°</button>
        <button id='disconnectBtn' class='bg-gray-600 px-4 py-2 rounded cursor-default' disabled>í•´ì œë¨</button>
      </div>
    </div>

    <div id='serialOutput'
        class='bg-black text-green-400 p-3 rounded-lg h-[40rem] overflow-y-auto font-mono text-lg whitespace-pre-wrap mb-4 leading-snug'></div>

    <div class='flex gap-3 mb-3'>
      <input id='msgInput' type='text' placeholder='ë©”ì‹œì§€ ì…ë ¥...'
            class='flex-1 bg-gray-700 border border-gray-600 rounded px-3 py-2'>
      <button id='sendBtn' class='bg-green-600 hover:bg-green-500 px-4 py-2 rounded'>ì „ì†¡</button>
    </div>

    <div class='flex items-center gap-4'>
      <button id='clearBtn' class='bg-gray-700 px-3 py-1 rounded hover:bg-gray-600'>ì§€ìš°ê¸°</button>
      <label class='flex items-center gap-2'>
        <input type='checkbox' id='autoScroll' checked> ìë™ ìŠ¤í¬ë¡¤
      </label>
    </div>
  </div>

  <!-- RIGHT PANEL -->
  <div class='w-[35%] bg-gray-800 p-5 rounded-xl shadow-lg border border-gray-700'>
    <h2 class='text-xl font-bold mb-4'>í”„ë¦¬ì…‹</h2>

    <div class='flex gap-2 mb-4'>
      <button id='importPreset' class='bg-gray-700 px-3 py-2 rounded hover:bg-gray-600'>ê°€ì ¸ì˜¤ê¸°</button>
      <button id='exportPreset' class='bg-gray-700 px-3 py-2 rounded hover:bg-gray-600'>ë‚´ë³´ë‚´ê¸°</button>
      <button id='deletePreset' class='bg-black hover:bg-gray-900 px-3 py-2 rounded text-white'>ì „ì²´ ì‚­ì œ</button>
    </div>

    <div class='flex gap-2 mb-4'>
      <input id='cmdInput' type='text' placeholder='Command'
            class='flex-1 bg-gray-700 border border-gray-600 rounded px-3 py-2'>
      <button id='addCmd' class='bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded'>ì¶”ê°€</button>
    </div>

    <div id='groupsContainer' class='flex flex-col gap-6'></div>
  </div>

</div> <!-- END MAIN LAYOUT -->

<script>
let port, reader, writer;
const decoder = new TextDecoder();
const encoder = new TextEncoder();
let presetData = {};

function safeEnding(){ return document.getElementById("ending").value; }

/* ============================================================
   IMPORT LOGIC â€” PROPER CMD PARSING
============================================================ */
document.getElementById("importPreset").onclick = () => {
  const input = document.createElement("input");
  input.type = "file";
  input.accept = ".txt,application/json";

  input.onchange = (e) => {
    const file = e.target.files[0];
    const reader2 = new FileReader();

    reader2.onload = () => {
      let text = reader2.result.trim();

      try {
        let json = JSON.parse(text);
        if (Array.isArray(json)) presetData = { "Default": json };
        else if (typeof json === "object") presetData = json;
        savePresets(); renderGroups(); return;
      } catch(e) {}

      text = text.replace(/^\{|\}$/g, "").trim();

      let lines = text
        .split(/\r?\n/)
        .map(v => v.trim())
        .filter(v => v.length > 0)
        .map(v => v.replace(/,$/, ""))
        .map(v => v.replace(/^"|"$/g, ""))
        .filter(v => v.length > 0);

      presetData = { "Default": lines };
      savePresets();
      renderGroups();
    };

    reader2.readAsText(file);
  };

  input.click();
};

/* ============================================================
   SERIAL / UI LOGIC
============================================================ */

async function readLoop(){
  try{
    reader = port.readable.getReader();
    const out = document.getElementById("serialOutput");

    while(true){
      const { value, done } = await reader.read();
      if(done) break;

      let t = decoder.decode(value);
      t = t.replace(/ERROR/gi, m => `âš ï¸ ${m}`);
      t = t.replace(/OK/gi, m => `ğŸŸ¢ ${m}`);
      out.innerHTML += t;

      if(document.getElementById("autoScroll").checked)
        out.scrollTop = out.scrollHeight;
    }
  } catch(err){ console.log("âš ï¸ í¬íŠ¸ ëŠê¹€:", err); }

  updateConnectionUI(false);
  try{ if(reader) reader.releaseLock(); }catch(e){}
}

document.getElementById("connectBtn").onclick = async () => {
  try{
    port = await navigator.serial.requestPort();
    await port.open({ baudRate:Number(document.getElementById("baud").value) });
    writer = port.writable.getWriter();
    readLoop();
    updateConnectionUI(true);
  }catch(e){ alert("ì—°ê²° ì‹¤íŒ¨: " + e); }
};

document.getElementById("disconnectBtn").onclick = async () => {
  try{
    if(reader) await reader.cancel();
    if(writer) await writer.close();
    if(port) await port.close();
  }catch(e){}
  updateConnectionUI(false);
};

document.getElementById("sendBtn").onclick = () => {
  if(!writer) return alert("í¬íŠ¸ê°€ ì—´ë ¤ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.");
  writer.write(encoder.encode(document.getElementById("msgInput").value + safeEnding()));
};

document.getElementById("msgInput").addEventListener("keydown", e => {
  if(e.key === "Enter"){
    e.preventDefault();
    document.getElementById("sendBtn").click();
  }
});

document.getElementById("clearBtn").onclick = () => {
  document.getElementById("serialOutput").textContent = "";
};

function savePresets(){ localStorage.setItem("presetGroups", JSON.stringify(presetData)); }
function loadPresets(){ presetData = JSON.parse(localStorage.getItem("presetGroups") || "{}"); renderGroups(); }

/* ============================================================
   RENDER PRESETS â€” CMD CLICK = AUTO SEND
============================================================ */
function renderGroups(){
  const container = document.getElementById("groupsContainer");
  container.innerHTML = "";

  Object.entries(presetData).forEach(([group, cmds]) => {
    const box = document.createElement("div");
    box.className = "bg-gray-700 p-3 rounded-lg border border-gray-600";

    const header = document.createElement("div");
    header.className = "flex justify-between items-center mb-2";

    const title = document.createElement("h3");
    title.className = "font-semibold text-blue-300";
    title.textContent = group;

    const groupDelete = document.createElement("button");
    groupDelete.innerHTML = "&#10005;";
    groupDelete.className =
      "w-6 h-6 flex items-center justify-center bg-black text-white rounded-full text-sm hover:bg-gray-900";
    groupDelete.onclick = () => {
      if(confirm(`'${group}' ê·¸ë£¹ ì „ì²´ ì‚­ì œ?`)){
        delete presetData[group];
        savePresets();
        renderGroups();
      }
    };

    header.appendChild(title);
    header.appendChild(groupDelete);

    const list = document.createElement("div");
    list.className = "flex flex-wrap gap-2";

    cmds.forEach((cmd, index) => {
      const tag = document.createElement("div");
      tag.className =
        "inline-flex items-center bg-gray-600 text-white px-3 py-1 rounded-full gap-2 cursor-pointer";

      const textSpan = document.createElement("span");
      textSpan.textContent = cmd;
      textSpan.onclick = () => {
        if (!writer) return alert("í¬íŠ¸ê°€ ì—´ë ¤ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.");
        writer.write(encoder.encode(cmd + safeEnding()));
      };

      const delBtn = document.createElement("button");
      delBtn.innerHTML = "&#10005;";
      delBtn.className =
        "w-4 h-4 flex items-center justify-center bg-black text-white rounded-full text-xs hover:bg-gray-900";

      delBtn.onclick = () => {
        presetData[group].splice(index,1);
        if(presetData[group].length === 0){
          delete presetData[group];
        }
        savePresets();
        renderGroups();
      };

      tag.appendChild(textSpan);
      tag.appendChild(delBtn);
      list.appendChild(tag);
    });

    box.appendChild(header);
    box.appendChild(list);
    container.appendChild(box);
  });
}

loadPresets();

document.getElementById("addCmd").onclick = () => {
  const cmd = document.getElementById("cmdInput").value.trim();
  if(!cmd) return;
  if(!presetData["Default"]) presetData["Default"] = [];
  presetData["Default"].push(cmd);
  savePresets();
  renderGroups();
  document.getElementById("cmdInput").value = "";
};

document.getElementById("deletePreset").onclick = () => {
  if(!confirm("ëª¨ë“  ê·¸ë£¹ê³¼ CMDê°€ ì‚­ì œë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
  presetData = {};
  savePresets();
  renderGroups();
};

document.getElementById("exportPreset").onclick = () => {
  const blob = new Blob([JSON.stringify(presetData,null,2)],{type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "presets.json";
  a.click();
};

function updateConnectionUI(connected){
  const c = document.getElementById("connectBtn");
  const d = document.getElementById("disconnectBtn");

  if(connected){
    c.disabled = true;
    c.className = "bg-green-600 hover:bg-green-500 px-4 py-2 rounded cursor-default";
    c.textContent = "ì—°ê²°ë¨";

    d.disabled = false;
    d.className = "bg-red-600 hover:bg-red-500 px-4 py-2 rounded";
    d.textContent = "í•´ì œ";
  } else {
    c.disabled = false;
    c.className = "bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded";
    c.textContent = "í¬íŠ¸ ì—°ê²°";

    d.disabled = true;
    d.className = "bg-gray-600 px-4 py-2 rounded cursor-default";
    d.textContent = "í•´ì œë¨";
  }
}
</script>

</body></html>
