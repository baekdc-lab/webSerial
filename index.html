<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>Web Serial Mini Console — Dark</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#0b0f14; --panel:#111827; --muted:#2a2f39; --text:#e5e7eb; --dim:#9aa4b2;
      --accent:#3b82f6; --success:#10b981; --danger:#ef4444; --radius:14px; --mono:"ui-monospace",SFMono-Regular,Menlo,Consolas,monospace;
    }
    html,body{height:100%}
    html{color-scheme:dark}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif}
    .container{max-width:1200px;margin:0 auto;padding:18px}
    header{display:flex;align-items:center;gap:10px;margin-bottom:10px}
    header h1{font-size:20px;margin:0;font-weight:700}
    header small{margin-left:auto;color:var(--dim)}

    .grid{display:grid;grid-template-columns: minmax(520px,1fr) 360px;gap:16px}
    @media (max-width: 980px){.grid{grid-template-columns:1fr}}

    .panel{background:var(--panel);border:1px solid var(--muted);border-radius:var(--radius);box-shadow:0 10px 25px rgba(0,0,0,.35);padding:14px}
    .panel h2{font-size:13px;color:var(--dim);margin:0 0 8px}

    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .grow{flex:1 1 auto}
    label{color:var(--dim)}
    select,input[type=text],textarea{background:#0e1622;color:var(--text);border:1px solid var(--muted);border-radius:10px;padding:8px 10px;outline:none;font-size:14px}
    select:focus,input:focus,textarea:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(59,130,246,.2)}

    button{padding:8px 12px;border-radius:10px;border:1px solid var(--muted);background:#0f172a;color:var(--text);cursor:pointer;font-size:14px}
    button:hover{border-color:#3b4150}
    button:disabled{opacity:.55;cursor:not-allowed}
    .btn-primary{background:linear-gradient(180deg,#2563eb,#1e40af);border-color:#1e3a8a}
    .btn-danger{background:linear-gradient(180deg,#b91c1c,#7f1d1d);border-color:#7f1d1d}
    .btn-success{background:linear-gradient(180deg,#059669,#047857);border-color:#065f46}
    .btn-ghost{background:transparent}

    .status-dot{display:inline-block;width:8px;height:8px;border-radius:50%;background:#64748b;margin-right:6px}
    .status-dot.on{background:#22c55e}
    .status{font-family:var(--mono);color:var(--dim)}

    #log{width:100%;height:420px;resize:vertical;box-sizing:border-box;font-family:var(--mono);font-size:16px}
    .small{font-size:12px;color:var(--dim)}

    .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--muted);border-radius:999px;background:#0f172a;margin:6px 6px 0 0;cursor:pointer;font-size:14px}
    .chip:hover{border-color:#3b4150}
    .chip .x{opacity:.7}

    .hint{display:block;margin-top:10px}
    .kbd{padding:.5px 6px;border:1px solid var(--muted);border-bottom-width:2px;border-radius:6px;background:#0f172a;color:var(--dim);font-family:var(--mono)}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Web Serial Mini Console</h1>
      <small>HTTPS(또는 localhost) · 크로미움 계열 브라우저 권장</small>
    </header>

    <div class="grid">
      <section class="panel">
        <div class="row" style="margin-bottom:8px">
          <label for="baud">Baud</label>
          <select id="baud">
            <option>115200</option><option>57600</option><option>38400</option>
            <option>19200</option><option selected>9600</option><option>4800</option><option>2400</option><option>1200</option>
          </select>
          <label for="ending">출력(전송)</label>
          <select id="ending">
            <option value="">없음</option>
            <option value="\n">LF (\\n)</option>
            <option value="\r\n" selected>CRLF (\\r\\n)</option>
            <option value="\r">CR (\\r)</option>
          </select>
          <label for="encoding">인코딩</label>
          <select id="encoding"><option selected>UTF-8</option></select>
          <span class="grow"></span>
          <button id="btnConnect" class="btn-primary">포트 연결</button>
          <button id="btnDisconnect" disabled>해제</button>
        </div>

        <div class="row small" style="margin-bottom:8px">
          <span class="status"><span id="dot" class="status-dot"></span><span id="status">대기 중</span></span>
          <label><input type="checkbox" id="chkAutoscroll" checked> 자동 스크롤</label>
        </div>

        <textarea id="log" readonly></textarea>

        <div class="row" style="margin-top:8px">
          <button id="btnClear" class="btn-ghost">로그 지우기</button>
          <button id="btnSave" class="btn-ghost">로그 저장</button>
          <span class="grow"></span>
          <label class="small"><input type="checkbox" id="chkEnterSend" checked> Enter로 전송 <span class="dim">(Shift+Enter 줄바꿈)</span></label>
        </div>

        <div class="row" style="margin-top:8px">
          <input id="tx" class="grow" type="text" placeholder="보낼 메시지..." />
          <button id="btnSend" class="btn-success">전송</button>
        </div>

        <span class="small hint">연결창이 안 뜨면: HTTPS/localhost에서 열고, 이 페이지를 <button id="btnOpenTop" class="btn-ghost">새 탭(최상위)으로 열기</button></span>
      </section>

      <aside class="panel">
        <h2>프리셋 추가</h2>
        <div class="row" style="margin-bottom:8px">
          <input id="presetText" class="grow" type="text" placeholder="예: STATUS, LED ON, NODE" />
          <button id="btnAdd" class="btn-primary">추가</button>
        </div>
        <div class="row" style="margin-bottom:8px">
          <button id="btnExport" class="btn-ghost">내보내기</button>
          <input id="importFile" type="file" accept="application/json" style="display:none">
          <button id="btnImport" class="btn-ghost">가져오기</button>
          <span class="grow"></span>
          <button id="btnClearPresets" class="btn-danger">전체 삭제</button>
        </div>
        <div id="chips"></div>
      </aside>
    </div>
  </div>

  <script>
    if (!("serial" in navigator)) {
      alert("이 브라우저는 Web Serial API를 지원하지 않습니다. Chrome/Edge 최신버전을 사용하세요.");
    }

    let port=null, reader=null, writer=null, readableClosed=null, writableClosed=null;
    const el=(id)=>document.getElementById(id);
    const setDot=(on)=> el('dot').classList.toggle('on', !!on);
    const status=(msg)=> el('status').textContent=msg;

    function setConnectedUI(connected){
      el('btnConnect').disabled=connected;
      el('btnDisconnect').disabled=!connected;
      el('baud').disabled=connected;
      el('ending').disabled=connected;
      el('encoding').disabled=connected;
      el('btnSend').disabled=!connected;
      el('tx').disabled=!connected;
      setDot(connected);
    }

    function appendLog(text){
      const log=el('log');
      log.value += text;
      if(el('chkAutoscroll').checked){ log.scrollTop = log.scrollHeight; }
    }

    function resolveEnding(){
      return el('ending').value.replace('\\n','\n').replace('\\r\\n','\r\n').replace('\\r','\r');
    }

    async function connect(){
      try{
        port=await navigator.serial.requestPort();
        const baudRate=Number(el('baud').value)||9600;
        await port.open({baudRate});
        const textDecoder=new TextDecoderStream();
        readableClosed=port.readable.pipeTo(textDecoder.writable).catch(()=>{});
        reader=textDecoder.readable.getReader();
        const textEncoder=new TextEncoderStream();
        writableClosed=textEncoder.readable.pipeTo(port.writable).catch(()=>{});
        writer=textEncoder.writable.getWriter();
        setConnectedUI(true); status(`연결됨 @ ${baudRate} baud`);
        readLoop();
      }catch(err){
        console.error(err); status('연결 실패'); alert('연결 실패:\n'+err); await disconnect(true);
      }
    }

    async function disconnect(silent=false){
      try{
        if(reader){ try{await reader.cancel()}catch{} try{await readableClosed}catch{} try{reader.releaseLock()}catch{} reader=null }
        if(writer){ try{await writer.close()}catch{} try{await writableClosed}catch{} try{writer.releaseLock()}catch{} writer=null }
        if(port){ try{await port.close()}catch{} port=null }
      }finally{ setConnectedUI(false); if(!silent) status('해제됨'); }
    }

    async function readLoop(){
      if(!reader) return;
      try{
        while(true){
          const {value, done}=await reader.read();
          if(done) break;
          if(value) appendLog(value);
        }
      }catch(err){ console.warn('readLoop error:', err) }
      finally{ if(port && !port.readable){ await disconnect(true); status('연결 끊김') } }
    }

    async function sendText(text){
      if(!port||!writer){ alert('포트가 연결되어 있지 않습니다.'); return }
      try{
        await writer.write(text+resolveEnding());
      }catch(err){ console.error(err); alert('전송 실패:\n'+err) }
    }

    function saveLog(){
      const blob=new Blob([el('log').value],{type:'text/plain;charset=utf-8'});
      const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='webserial-log.txt';a.click();URL.revokeObjectURL(a.href);
    }

    const LS_KEY='ws_presets_chips_v1';
    const load=()=>{try{return JSON.parse(localStorage.getItem(LS_KEY))||[]}catch{return[]}};
    const save=(arr)=>localStorage.setItem(LS_KEY,JSON.stringify(arr));

    function renderChips(){
      const host=el('chips'); host.innerHTML='';
      const items=load();
      if(!items.length){ const s=document.createElement('div'); s.className='small'; s.textContent='클릭하면 즉시 전송됩니다.'; host.appendChild(s); return }
      items.forEach((t,i)=>{
        const chip=document.createElement('button'); chip.type='button'; chip.className='chip'; chip.title=t; chip.textContent=t; chip.addEventListener('click',()=>sendText(t));
        const x=document.createElement('span'); x.className='x'; x.textContent='✕'; x.title='삭제'; x.addEventListener('click',(e)=>{e.stopPropagation(); delChip(i)});
        chip.appendChild(x); host.appendChild(chip);
      })
    }
    function addChip(text){const arr=load(); arr.unshift(String(text)); save(arr); renderChips()}
    function delChip(idx){const arr=load(); arr.splice(idx,1); save(arr); renderChips()}

    el('btnConnect').addEventListener('click',connect);
    el('btnDisconnect').addEventListener('click',()=>disconnect());
    el('btnSend').addEventListener('click',()=>sendText(el('tx').value));
    el('btnClear').addEventListener('click',()=>{el('log').value='' });
    el('btnSave').addEventListener('click',saveLog);
    el('btnOpenTop').addEventListener('click',()=>{window.open(location.href,'_blank','noopener')});

    el('tx').addEventListener('keydown',(ev)=>{if(ev.key==='Enter'&&!ev.shiftKey&&el('chkEnterSend').checked){ev.preventDefault();sendText(el('tx').value)}});

    el('btnAdd').addEventListener('click',()=>{const v=el('presetText').value.trim();if(!v)return;addChip(v);el('presetText').value='';el('presetText').focus()});
    el('btnExport').addEventListener('click',()=>{
      const blob=new Blob([JSON.stringify(load(),null,2)],{type:'application/json'});
      const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='webserial-presets.json';a.click();URL.revokeObjectURL(a.href);
    });
    el('btnImport').addEventListener('click',()=>el('importFile').click());
    el('importFile').addEventListener('change',(e)=>{const f=e.target.files&&e.target.files[0];if(!f)return;const r=new FileReader();r.onload=()=>{try{const arr=JSON.parse(r.result);if(!Array.isArray(arr))throw new Error('형식 오류');save(arr.map(String));renderChips()}catch(err){alert('가져오기 실패: '+err.message)}};r.readAsText(f);e.target.value=''});
    el('btnClearPresets').addEventListener('click',()=>{if(!confirm('모든 프리셋을 삭제할까요?'))return;save([]);renderChips()});

    setConnectedUI(false); renderChips();
    window.addEventListener('beforeunload',async()=>{await disconnect(true)});
  </script>
</body>
</html>
